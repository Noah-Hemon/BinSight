<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinSight - Tableau de Bord Interactif</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
        }
        .filter-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        .real-time-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            background: #28a745;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        .custom-select {
            border-radius: 8px;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row">
            <div class="col-12">
                <nav class="navbar navbar-expand-lg navbar-dark bg-dark rounded mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand" href="#">
                            <i class="fas fa-chart-line"></i> BinSight Dashboard
                        </a>
                        <div class="navbar-nav ms-auto">
                            <a class="nav-link" href="/"><i class="fas fa-home"></i> Accueil</a>
                            <a class="nav-link" href="/rules"><i class="fas fa-cog"></i> Règles</a>
                            <a class="nav-link" href="/upload"><i class="fas fa-upload"></i> Upload</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Filtres -->
        <div class="filter-panel">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Période</label>
                    <select class="form-select custom-select" id="periodFilter">
                        <option value="7">7 derniers jours</option>
                        <option value="30" selected>30 derniers jours</option>
                        <option value="90">90 derniers jours</option>
                        <option value="365">1 an</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Type de poubelle</label>
                    <select class="form-select custom-select" id="binTypeFilter">
                        <option value="all">Tous les types</option>
                        <option value="general">Générale</option>
                        <option value="recyclage">Recyclage</option>
                        <option value="organique">Organique</option>
                        <option value="verre">Verre</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Emplacement</label>
                    <select class="form-select custom-select" id="locationFilter">
                        <option value="all">Tous les emplacements</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Actions</label>
                    <div class="btn-group w-100">
                        <button class="btn btn-primary" onclick="updateDashboard()">
                            <i class="fas fa-sync"></i> Actualiser
                        </button>
                        <button class="btn btn-success" onclick="exportData()">
                            <i class="fas fa-download"></i> Exporter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Métriques principales -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card dashboard-card metric-card">
                    <div class="card-body text-center position-relative">
                        <div class="real-time-indicator"></div>
                        <div class="stat-number" id="totalImages">-</div>
                        <div class="stat-label">Images Analysées</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card metric-card">
                    <div class="card-body text-center">
                        <div class="stat-number" id="fullBins">-</div>
                        <div class="stat-label">Poubelles Pleines</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card metric-card">
                    <div class="card-body text-center">
                        <div class="stat-number" id="emptyBins">-</div>
                        <div class="stat-label">Poubelles Vides</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card dashboard-card metric-card">
                    <div class="card-body text-center">
                        <div class="stat-number" id="accuracy">-</div>
                        <div class="stat-label">Précision IA</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Évolution Temporelle</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="timelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Répartition des États</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-map-marker-alt"></i> Analyse par Emplacement</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="locationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-robot"></i> Performance de Classification</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tableau des données récentes -->
        <div class="row">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header">
                        <h5><i class="fas fa-table"></i> Données Récentes</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="recentDataTable">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Date</th>
                                        <th>État</th>
                                        <th>Type</th>
                                        <th>Emplacement</th>
                                        <th>Confiance IA</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recentDataBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let charts = {};
        
        // Initialiser le dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadLocations();
            updateDashboard();
            
            // Mise à jour automatique toutes les 30 secondes
            setInterval(updateDashboard, 30000);
        });
        
        function initCharts() {
            // Graphique temporel
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            charts.timeline = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Pleines',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Vides',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Graphique circulaire
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pleines', 'Vides', 'À moitié', 'Incertaines'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#E7E9ED'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Graphique par emplacement
            const locationCtx = document.getElementById('locationChart').getContext('2d');
            charts.location = new Chart(locationCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Nombre de poubelles',
                        data: [],
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgb(54, 162, 235)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Graphique de performance
            const performanceCtx = document.getElementById('performanceChart').getContext('2d');
            charts.performance = new Chart(performanceCtx, {
                type: 'radar',
                data: {
                    labels: ['Précision', 'Rappel', 'F1-Score', 'Spécificité', 'Sensibilité'],
                    datasets: [{
                        label: 'Performance IA',
                        data: [0, 0, 0, 0, 0],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });
        }
        
        function updateDashboard() {
            const period = document.getElementById('periodFilter').value;
            const binType = document.getElementById('binTypeFilter').value;
            const location = document.getElementById('locationFilter').value;
            
            const params = new URLSearchParams({
                period: period,
                bin_type: binType,
                location: location
            });
            
            // Charger les métriques
            fetch(`/api/dashboard/metrics?${params}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalImages').textContent = data.total_images;
                    document.getElementById('fullBins').textContent = data.full_bins;
                    document.getElementById('emptyBins').textContent = data.empty_bins;
                    document.getElementById('accuracy').textContent = (data.accuracy * 100).toFixed(1) + '%';
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les données des graphiques
            fetch(`/api/dashboard/timeline?${params}`)
                .then(response => response.json())
                .then(data => {
                    charts.timeline.data.labels = data.labels;
                    charts.timeline.data.datasets[0].data = data.full_data;
                    charts.timeline.data.datasets[1].data = data.empty_data;
                    charts.timeline.update();
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les données de statut
            fetch(`/api/dashboard/status?${params}`)
                .then(response => response.json())
                .then(data => {
                    charts.status.data.datasets[0].data = [
                        data.full, data.empty, data.half, data.unclear
                    ];
                    charts.status.update();
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les données par emplacement
            fetch(`/api/dashboard/locations?${params}`)
                .then(response => response.json())
                .then(data => {
                    charts.location.data.labels = data.labels;
                    charts.location.data.datasets[0].data = data.counts;
                    charts.location.update();
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les données de performance
            fetch(`/api/dashboard/performance?${params}`)
                .then(response => response.json())
                .then(data => {
                    charts.performance.data.datasets[0].data = [
                        data.precision, data.recall, data.f1_score, 
                        data.specificity, data.sensitivity
                    ];
                    charts.performance.update();
                })
                .catch(error => console.error('Erreur:', error));
            
            // Charger les données récentes
            loadRecentData(params);
        }
        
        function loadLocations() {
            fetch('/api/locations')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('locationFilter');
                    data.forEach(location => {
                        const option = document.createElement('option');
                        option.value = location;
                        option.textContent = location;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Erreur:', error));
        }
        
        function loadRecentData(params) {
            fetch(`/api/dashboard/recent?${params}`)
                .then(response => response.json())
                .then(data => {
                    const tbody = document.getElementById('recentDataBody');
                    tbody.innerHTML = '';
                    
                    data.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><img src="${item.image_url}" width="50" height="50" class="rounded"></td>
                            <td>${new Date(item.upload_date).toLocaleDateString()}</td>
                            <td><span class="badge bg-${getStatusColor(item.status)}">${item.status}</span></td>
                            <td>${item.bin_type || 'N/A'}</td>
                            <td>${item.location || 'N/A'}</td>
                            <td>${(item.confidence * 100).toFixed(1)}%</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewImage(${item.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="editAnnotation(${item.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => console.error('Erreur:', error));
        }
        
        function getStatusColor(status) {
            const colors = {
                'full': 'danger',
                'empty': 'success',
                'half': 'warning',
                'unclear': 'secondary'
            };
            return colors[status] || 'secondary';
        }
        
        function viewImage(imageId) {
            window.open(`/view/${imageId}`, '_blank');
        }
        
        function editAnnotation(imageId) {
            window.location.href = `/annotate/${imageId}`;
        }
        
        function exportData() {
            const period = document.getElementById('periodFilter').value;
            const binType = document.getElementById('binTypeFilter').value;
            const location = document.getElementById('locationFilter').value;
            
            const params = new URLSearchParams({
                period: period,
                bin_type: binType,
                location: location
            });
            
            window.open(`/api/export/csv?${params}`, '_blank');
        }
        
        // Écouteurs d'événements pour les filtres
        document.getElementById('periodFilter').addEventListener('change', updateDashboard);
        document.getElementById('binTypeFilter').addEventListener('change', updateDashboard);
        document.getElementById('locationFilter').addEventListener('change', updateDashboard);
    </script>
</body>
</html>