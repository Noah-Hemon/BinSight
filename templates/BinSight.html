<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinSight - Surveillance Intelligente des Poubelles Publiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="icon" href="{{ url_for('static', filename='img/Poubello.png') }}" type="image/png">
    <style>
        #map { height: 600px; }
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .file-upload:hover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .file-upload.dragover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-empty { background-color: #4ade80; }
        .status-full { 
            background-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .selected-row {
            background-color: #dbeafe !important; /* Tailwind's blue-100 */
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="{{ url_for('static', filename='img/logo_binsight.png') }}" alt="Logo BinSight" class="h-12 w-12 mr-2">
                <h1 class="text-2xl font-bold">BinSight</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#hero-section" class="hover:text-green-200 font-medium">Accueil</a>
                <a href="#signalement-section" class="hover:text-green-200 font-medium">Signalements</a>
                <a href="#stats-section" class="hover:text-green-200 font-medium">Statistiques</a>
                <a href="#about-section" class="hover:text-green-200 font-medium">√Ä propos</a>
                <a href="/about" class="hover:text-green-200 font-medium">L'√©quipe de BinSight</a>
            </nav>
            <div class="flex items-center space-x-4">
                {% if is_admin %}
                    <a href="/logout" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition text-white">
                        <i class="fas fa-sign-out-alt mr-2"></i>D√©connexion
                    </a>
                {% else %}
                    <a href="/login" class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg font-medium transition text-white">
                        <i class="fas fa-user mr-2"></i>Connexion
                    </a>
                {% endif %}
                <button class="md:hidden text-2xl" id="mobile-menu-button">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="md:hidden hidden bg-green-700 px-4 py-2" id="mobile-menu">
            <a href="#hero-section" class="block py-2 hover:text-green-200">Accueil</a>
            <a href="#signalement-section" class="block py-2 hover:text-green-200">Signalements</a>
            <a href="#stats-section" class="block py-2 hover:text-green-200">Statistiques</a>
            <a href="#about-section" class="block py-2 hover:text-green-200">√Ä propos</a>
            <a href="/about" class="block py-2 hover:text-green-200">√Ä propos de BinSight</a>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="hero-section" class="bg-gradient-to-r from-green-500 to-green-700 text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Surveillance Intelligente des Poubelles Publiques</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Une solution innovante pour d√©tecter l'√©tat des poubelles et am√©liorer la gestion des d√©chets urbains
            </p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button id="scroll-report-btn" class="bg-white text-green-700 hover:bg-gray-100 px-6 py-3 rounded-lg font-bold text-lg transition shadow-lg">
                    <i class="fas fa-upload mr-2"></i>Signaler une poubelle
                </button>
                <button id="scroll-map-btn" class="bg-transparent border-2 border-white hover:bg-white hover:text-green-700 px-6 py-3 rounded-lg font-bold text-lg transition">
                    <i class="fas fa-map-marked-alt mr-2"></i>Voir la carte
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <!-- Upload Section -->
        <section id="signalement-section" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Signaler une poubelle</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="file-upload" id="drop-area">
                    <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">D√©posez votre image ici</h3>
                    <p class="text-gray-500 mb-4">ou</p>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                    <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
                        <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
                    </label>
                    <p class="text-sm text-gray-500 mt-4">Formats support√©s: JPG, PNG, JPEG</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Ajouter des d√©tails</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Localisation</label>
                            <input type="text" id="location-input" placeholder="Adresse ou coordonn√©es GPS" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Type de poubelle</label>
                            <select id="bin-type-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option>S√©lectionnez un type</option>
                                <option>Poubelle standard</option>
                                <option>Poubelle de tri</option>
                                <option>Conteneur</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">√âtat de la poubelle</label>
                            <select id="status-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="" id="auto-classify-option">Laissez l'IA d√©cider</option>
                                <option value="pleine">Pleine</option>
                                <option value="vide">Vide</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1" id="auto-classify-help">Si vous ne s√©lectionnez rien, l'IA analysera automatiquement l'image</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Commentaire (optionnel)</label>
                            <textarea id="comment-textarea" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ajoutez des d√©tails suppl√©mentaires..."></textarea>
                        </div>
                        <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition w-full">
                            <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section id="map-section" class="mb-16">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Cartographie des poubelles</h2>
                <div class="flex space-x-2">
                    <button class="bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-filter mr-2"></i>Filtrer
                    </button>
                    <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition" onclick="loadMapData()">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4">
                <div id="map" class="rounded-lg" style="z-index: 0;"></div>
                <div class="flex justify-center mt-4 space-x-6">
                    <div class="flex items-center">
                        <span class="status-indicator status-empty"></span>
                        <span>Vide</span>
                    </div>
                    <div class="flex items-center">
                        <span class="status-indicator status-full"></span>
                        <span>Pleine</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="stats-section" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Statistiques et analyses</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Signalements aujourd'hui</p>
                            <h3 id="today-uploads" class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-upload text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-green-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>En temps r√©el
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Poubelles pleines</p>
                            <h3 id="full-bins" class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-red-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>Surveillance active
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Taux de pr√©cision</p>
                            <h3 id="accuracy" class="text-3xl font-bold mt-2">0%</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-brain text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-blue-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>IA en apprentissage
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <canvas id="statsChart" height="300"></canvas>
            </div>
        </section>

        <!-- Recent Reports -->
        <section>
            <h2 class="text-3xl font-bold mb-6">Derniers signalements</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200" id="recent-reports-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localisation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Les signalements seront charg√©s dynamiquement -->
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-center text-gray-500" id="no-reports" style="display: none;">
                    Aucun signalement pour le moment
                </div>
                <!-- NOUVEAU: Conteneur pour les contr√¥les de pagination -->
                <div id="pagination-controls" class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
                    <!-- Les contr√¥les de pagination seront g√©n√©r√©s dynamiquement ici -->
                </div>
            </div>
        </section>

        <!-- NOUVEAU: Section Outils d'Administration -->
        {% if is_admin %}
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-6">Outils d'Administration</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Outil 1: V√©rification de l'int√©grit√© -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">V√©rification de l'int√©grit√©</h3>
                        <p class="text-gray-600 mt-1">
                            Analysez la base de donn√©es pour trouver les fichiers manquants ou orphelins.
                        </p>
                    </div>
                    <div id="integrity-report-container" class="mt-4"></div>
                    <button id="verify-integrity-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition mt-4 w-full">
                        <i class="fas fa-shield-alt mr-2"></i>Lancer la v√©rification
                    </button>
                </div>

                <!-- Outil 2: Importation en masse -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">Importation en masse</h3>
                        <p class="text-gray-600 mt-1">
                            Importer toutes les images des dossiers `Data/test` et `Data/train`.
                        </p>
                    </div>
                    <div id="batch-import-report-container" class="mt-4"></div>
                    <button id="batch-import-btn" class="bg-teal-600 hover:bg-teal-700 text-white px-6 py-3 rounded-lg transition mt-4 w-full">
                        <i class="fas fa-file-import mr-2"></i>D√©marrer l'importation
                    </button>
                </div>
                
                <!-- NOUVEAU: Outil 3: R√©-analyse compl√®te -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">R√©-analyse compl√®te</h3>
                        <p class="text-gray-600 mt-1">
                            Appliquer √† nouveau l'algorithme de classification sur toutes les images existantes.
                        </p>
                    </div>
                    <div id="reclassify-report-container" class="mt-4"></div>
                    <button id="reclassify-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition mt-4 w-full">
                        <i class="fas fa-sync-alt mr-2"></i>Lancer la r√©-analyse
                    </button>
                </div>

                <!-- Outil 4: Suppression de toutes les images -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">Suppression de toutes les images</h3>
                        <p class="text-gray-600 mt-1">
                            Supprime toutes les images et leurs donn√©es de la base de donn√©es et du serveur.
                        </p>
                    </div>
                    <div id="delete-all-report-container" class="mt-4"></div>
                    <button id="delete-all-btn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition mt-4 w-full">
                        <i class="fas fa-trash-alt mr-2"></i>Supprimer toutes les images
                    </button>
                </div>

                <!-- Outil 5: S√©lecteur de mode de classification -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">Mode de classification</h3>
                        <p class="text-gray-600 mt-1">
                            Choisissez la m√©thode de classification utilis√©e pour les nouvelles images.
                        </p>
                        <select id="classifier-mode-select" class="mt-4 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                            <option value="ia">IA (Intelligence Artificielle)</option>
                            <option value="rules">R√®gles (logique experte)</option>
                        </select>
                        <div id="classifier-mode-status" class="mt-2 text-sm text-gray-500"></div>
                    </div>
                </div>

                <!-- Outil 6: R√©entra√Ænement IA -->
                <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col">
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-800">R√©entra√Ænement IA</h3>
                        <p class="text-gray-600 mt-1">
                            Relance l'entra√Ænement du mod√®le IA sur les images labellis√©es.<br>
                            Les m√©triques s'affichent dans la console serveur.
                        </p>
                    </div>
                    <button id="retrain-ia-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg transition mt-4 w-full">
                        <i class="fas fa-robot mr-2"></i>R√©entra√Æner l'IA
                    </button>
                </div>
            </div>
        </section>
        {% endif %}
    </main>

    <!-- About Section -->
    <section id="about-section" class="bg-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl font-bold mb-4">√Ä propos de BinSight</h2>
            <p class="text-lg text-gray-700 max-w-2xl mx-auto">
                BinSight est une solution innovante de surveillance intelligente des poubelles publiques, utilisant l'intelligence artificielle pour am√©liorer la gestion des d√©chets urbains. Notre mission est de rendre les villes plus propres et plus efficaces gr√¢ce √† la technologie.
            </p>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i> BinSight
                    </h3>
                    <p class="text-gray-400">
                        Une solution innovante pour am√©liorer la gestion des d√©chets urbains gr√¢ce √† l'intelligence artificielle.
                    </p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Liens rapides</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Accueil</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Signalements</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Statistiques</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">√Ä propos</a></li>
                        <li><a href="/about" class="text-gray-400 hover:text-white transition">√Ä propos de BinSight</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ressources</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Documentation</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">API</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">FAQ</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Newsletter</h4>
                    <p class="text-gray-400 mb-4">
                        Abonnez-vous pour recevoir les derni√®res actualit√©s et mises √† jour.
                    </p>
                    <div class="flex">
                        <input type="email" placeholder="Votre email" class="px-4 py-2 rounded-l-lg w-full focus:outline-none text-gray-800">
                        <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-r-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-400 mb-4 md:mb-0">
                    ¬© 2025 BinSight. Tous droits r√©serv√©s.
                </p>
                <div class="flex space-x-6">
                    <a href="https://en.wikipedia.org/wiki/Special:Random" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="https://en.wikipedia.org/wiki/Special:Random" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="https://en.wikipedia.org/wiki/Special:Random" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://en.wikipedia.org/wiki/Special:Random" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

<script>
let poubelles = [];
let currentImageId = null;
let map;

// Mobile menu toggle
document.getElementById('mobile-menu-button').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
});

// File upload drag and drop
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropArea.classList.add('dragover');
}

function unhighlight() {
    dropArea.classList.remove('dragover');
}

dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

// ‚ú® NOUVELLE FONCTION avec preview de l'image
function handleFiles(files) {
    console.log('=== HANDLE FILES APPEL√â ===');
    console.log('Nombre de fichiers:', files.length);
    
    if (files.length > 0) {
        const file = files[0];
        console.log('Fichier s√©lectionn√©:', {
            name: file.name,
            size: file.size,
            type: file.type
        });
        
        if (file.type.startsWith('image/')) {
            console.log('‚úÖ Type de fichier valide');
            
            // üñºÔ∏è Afficher la preview de l'image
            showImagePreview(file);
            
        } else {
            console.log('‚ùå Type de fichier invalide:', file.type);
            showErrorMessage('‚ùå Veuillez s√©lectionner une image valide (JPG, PNG, JPEG).');
        }
    } else {
        console.log('‚ùå Aucun fichier s√©lectionn√©');
        showErrorMessage('‚ùå Aucun fichier s√©lectionn√©.');
    }
}

// ‚ú® NOUVELLE FONCTION pour afficher la preview
function showImagePreview(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        dropArea.innerHTML = `
            <div class="w-full">
                <!-- Preview de l'image -->
                <div class="mb-6 text-center">
                    <img src="${e.target.result}" alt="Preview" class="max-w-full max-h-80 mx-auto rounded-lg border-2 border-gray-300 object-contain shadow-lg">
                </div>
                
                <!-- Informations sur le fichier -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">üì∑ Image s√©lectionn√©e</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                        <div><strong>Nom :</strong> ${file.name}</div>
                        <div><strong>Taille :</strong> ${(file.size / 1024).toFixed(1)} Ko</div>
                        <div><strong>Type :</strong> ${file.type}</div>
                        <div><strong>Derni√®re modification :</strong> ${new Date(file.lastModified).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="uploadCurrentImage()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                    </button>
                    <button onclick="selectNewImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-exchange-alt mr-2"></i>Changer d'image
                    </button>
                    <button onclick="cancelImageUpload()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </button>
                </div>
                
                <!-- Note d'aide -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500">
                        üí° V√©rifiez que l'image est correcte avant d'envoyer le signalement
                    </p>
                </div>
            </div>
        `;
    };
    
    reader.onerror = function() {
        showErrorMessage('Erreur lors de la lecture du fichier');
        resetUploadArea();
    };
    
    reader.readAsDataURL(file);
    
    // Stocker le fichier pour l'upload ult√©rieur
    window.currentFile = file;
}

// ‚ú® NOUVELLE FONCTION pour uploader l'image apr√®s preview
function uploadCurrentImage() {
    if (!window.currentFile) {
        showErrorMessage('Aucune image s√©lectionn√©e');
        return;
    }
    
    const file = window.currentFile;
    console.log('üöÄ D√©but upload de l\'image apr√®s preview...');
    
    const formData = new FormData();
    formData.append('file', file);
    
    // R√©cup√©rer les valeurs des champs du formulaire
    const location = document.getElementById('location-input').value;
    const binType = document.getElementById('bin-type-select').value;
    const comment = document.getElementById('comment-textarea').value;
    const userAnnotation = document.getElementById('status-select').value;
    
    console.log('Donn√©es du formulaire:', {
        location: location,
        binType: binType,
        comment: comment,
        userAnnotation: userAnnotation
    });
    
    formData.append('location', location);
    formData.append('bin_type', binType);
    formData.append('comment', comment);
    formData.append('user_annotation', userAnnotation);
    
    // Afficher indicateur de chargement avec animation
    dropArea.innerHTML = `
        <div class="w-full text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyse en cours...</h3>
                <p class="text-gray-600 mb-4">Extraction des caract√©ristiques et classification IA</p>
            </div>
            
            <!-- Barre de progression anim√©e -->
            <div class="bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                <div class="bg-green-500 h-3 rounded-full animate-pulse" style="width: 65%; animation: pulse 1.5s infinite;"></div>
            </div>
            
            <div class="text-sm text-gray-500 space-y-1">
                <p>üìä Analyse des caract√©ristiques visuelles...</p>
                <p>ü§ñ Classification automatique en cours...</p>
                <p>üíæ Sauvegarde dans la base de donn√©es...</p>
            </div>
        </div>
    `;
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('üì• R√©ponse re√ßue:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('üìä Donn√©es JSON:', data);
        
        // Restaurer l'interface
        resetUploadArea();
        
        if (data.success) {
            console.log('‚úÖ Upload r√©ussi !');
            
            // Afficher les r√©sultats avec plus de d√©tails
            showAnalysisResults(data);
            
            // Rafra√Æchir toutes les donn√©es
            loadStats();
            loadRecentReports();
            loadMapData();
            
            // R√©initialiser le formulaire
            resetForm();
            
            // Nettoyer le fichier stock√©
            window.currentFile = null;
            
            // Message de succ√®s personnalis√©
            const confidence = data.confidence || '0%';
            const statusEmoji = data.classification === 'pleine' ? 'üóëÔ∏è' : '‚ú®';
            showSuccessMessage(`${statusEmoji} Signalement envoy√© ! Poubelle class√©e comme "${data.classification}" (Confiance: ${confidence})`);
        } else {
            console.log('‚ùå Erreur serveur:', data.message);
            showErrorMessage('Erreur serveur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur compl√®te:', error);
        resetUploadArea();
        
        if (error.message.includes('Failed to fetch')) {
            showErrorMessage('‚ùå Impossible de se connecter au serveur. V√©rifiez que Flask tourne sur http://localhost:5000');
        } else if (error.message.includes('NetworkError')) {
            showErrorMessage('‚ùå Erreur r√©seau. V√©rifiez votre connexion internet.');
        } else {
            showErrorMessage('‚ùå Erreur lors de l\'upload: ' + error.message);
        }
    });
}

// ‚ú® FONCTION pour annuler l'upload
function cancelImageUpload() {
    window.currentFile = null;
    resetUploadArea();
    showSuccessMessage('Upload annul√©');
}

// ‚ú® FONCTION pour s√©lectionner une nouvelle image
function selectNewImage() {
    window.currentFile = null;
    resetUploadArea();
    
    // D√©clencher automatiquement le s√©lecteur de fichier
    setTimeout(() => {
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.click();
        }
    }, 100);
}

// Fonction am√©lior√©e pour r√©initialiser la zone d'upload
function resetUploadArea() {
    dropArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">D√©posez votre image ici</h3>
        <p class="text-gray-500 mb-4">ou</p>
        <input type="file" id="file-input" accept="image/*" class="hidden">
        <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
            <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
        </label>
        <p class="text-sm text-gray-500 mt-4">Formats support√©s: JPG, PNG, JPEG (max 16 Mo)</p>
    `;
    
    // R√©attacher l'event listener au nouveau input
    const newFileInput = document.getElementById('file-input');
    if (newFileInput) {
        newFileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
    }
    
    // R√©attacher les √©v√©nements de drag and drop
    attachDragAndDropEvents();
}

// Fonction pour r√©attacher les √©v√©nements drag and drop
function attachDragAndDropEvents() {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    dropArea.addEventListener('drop', handleDrop, false);
}

// Fonction pour r√©initialiser le formulaire
function resetForm() {
    document.getElementById('location-input').value = '';
    document.getElementById('bin-type-select').selectedIndex = 0;
    document.getElementById('status-select').selectedIndex = 0;
    document.getElementById('comment-textarea').value = '';
}

// Fonction am√©lior√©e pour afficher un message de succ√®s
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entr√©e
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement apr√®s 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction am√©lior√©e pour afficher un message d'erreur
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entr√©e
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement apr√®s 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction am√©lior√©e pour afficher les r√©sultats d'analyse
function showAnalysisResults(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-lg w-full max-h-screen overflow-y-auto">
            <!-- En-t√™te avec ic√¥ne de succ√®s -->
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-3xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Analyse termin√©e !</h3>
                <p class="text-gray-600 mt-2">Votre signalement a √©t√© trait√© avec succ√®s</p>
            </div>
            
            <!-- Image analys√©e -->
            <div class="mb-6">
                <img src="${data.image_url}" class="w-full h-48 object-cover rounded-lg border shadow-sm" alt="Image analys√©e">
            </div>
            
            <!-- R√©sultats principaux -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-brain mr-2 text-blue-600"></i>R√©sultats de l'analyse IA
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Classification :</span>
                        <span class="font-bold text-lg ${data.classification === 'pleine' ? 'text-red-600' : 'text-green-600'}">
                            ${data.classification === 'pleine' ? 'üóëÔ∏è' : '‚ú®'} Poubelle ${data.classification}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Niveau de confiance :</span>
                        <span class="font-medium text-blue-600">${data.confidence}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Source :</span>
                        <span class="font-medium">${data.is_user_annotation ? 'üë§ Annotation utilisateur' : 'ü§ñ Intelligence artificielle'}</span>
                    </div>
                </div>
            </div>
            
            <!-- D√©tails techniques -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>D√©tails techniques
                </h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="text-gray-600">Dimensions :</div>
                    <div class="font-medium">${data.features.width} √ó ${data.features.height} px</div>
                    <div class="text-gray-600">Taille du fichier :</div>
                    <div class="font-medium">${(data.features.file_size / 1024).toFixed(1)} Ko</div>
                    <div class="text-gray-600">Luminosit√© moyenne :</div>
                    <div class="font-medium">${data.features.brightness.toFixed(1)}</div>
                    <div class="text-gray-600">Niveau de contraste :</div>
                    <div class="font-medium">${data.features.contrast_level.toFixed(1)}</div>
                </div>
            </div>
            
            <!-- Actions de correction (seulement pour l'IA) -->
            ${!data.is_user_annotation ? `
            <div class="border-t pt-4 mb-6">
                <p class="text-sm text-gray-600 mb-3 text-center">
                    <i class="fas fa-question-circle mr-1"></i>L'IA a-t-elle correctement classifi√© cette image ?
                </p>
                <div class="flex gap-2">
                    <button onclick="annotateImage(${data.image_id}, 'pleine')" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition font-medium">
                        <i class="fas fa-times mr-2"></i>Non, elle est pleine
                    </button>
                    <button onclick="annotateImage(${data.image_id}, 'vide')" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-medium">
                        <i class="fas fa-check mr-2"></i>Non, elle est vide
                    </button>
                </div>
            </div>
            ` : ''}
            
            <!-- Bouton de fermeture -->
            <div class="text-center">
                <button onclick="closeModal(this)" class="bg-gray-600 text-white px-8 py-3 rounded-lg hover:bg-gray-700 transition font-medium">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    currentImageId = data.image_id;
}

// Fonction pour annoter une image
function annotateImage(imageId, annotation) {
    fetch(`/annotate/${imageId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`‚úÖ Correction enregistr√©e ! L'image a √©t√© annot√©e comme "${annotation}"`);
                loadStats();
                loadRecentReports();
                loadMapData();
                // Fermer la modal apr√®s annotation
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

function closeModal(button) {
    const modal = button.closest('.fixed');
    modal.remove();
}



// Fonction pour charger les statistiques depuis l'API
function loadStats() {
    console.log('üìä Chargement des statistiques...');
    
    fetch('/api/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä Statistiques re√ßues:', data);
            
            // Mettre √† jour les cartes de statistiques
            updateStatsCards(data);
            
            // Mettre √† jour le graphique
            updateChart(data.monthly_data);
            
            console.log('‚úÖ Statistiques mises √† jour avec succ√®s');
        })
        .catch(error => {
            console.error('‚ùå Erreur lors du chargement des statistiques:', error);
            
            // Afficher des valeurs par d√©faut en cas d'erreur
            updateStatsCards({
                today_uploads: 0,
                full_bins: 0,
                accuracy: 0.0,
                monthly_data: []
            });
            
            // Optionnel : afficher un message d'erreur discret
            console.warn('Utilisation des statistiques par d√©faut en raison d\'une erreur');
        });
}

// Fonction pour mettre √† jour les cartes de statistiques
function updateStatsCards(data) {
    // Signalements aujourd'hui
    const todayUploadsElement = document.getElementById('today-uploads');
    if (todayUploadsElement) {
        todayUploadsElement.textContent = data.today_uploads || 0;
    }
    // Poubelles pleines
    const fullBinsElement = document.getElementById('full-bins');
    if (fullBinsElement) {
        fullBinsElement.textContent = data.full_bins || 0;
        // Ajouter une animation si le nombre est √©lev√©
        if (data.full_bins > 5) {
            fullBinsElement.classList.add('text-red-600');
            fullBinsElement.parentElement.parentElement.classList.add('border-l-4', 'border-red-500');
        } else {
            fullBinsElement.classList.remove('text-red-600');
            fullBinsElement.parentElement.parentElement.classList.remove('border-l-4', 'border-red-500');
        }
    }
    // Taux de pr√©cision
    const accuracyElement = document.getElementById('accuracy');
    if (accuracyElement) {
        const accuracy = data.accuracy || 0;
        accuracyElement.textContent = `${accuracy}%`;
        // Changer la couleur selon la pr√©cision
        if (accuracy >= 80) {
            accuracyElement.classList.add('text-green-600');
            accuracyElement.classList.remove('text-yellow-600', 'text-red-600');
        } else if (accuracy >= 60) {
            accuracyElement.classList.add('text-yellow-600');
            accuracyElement.classList.remove('text-green-600', 'text-red-600');
        } else {
            accuracyElement.classList.add('text-red-600');
            accuracyElement.classList.remove('text-green-600', 'text-yellow-600');
        }
    }
    // Mettre √† jour les indicateurs de tendance
    updateTrendIndicators(data);
}

// Fonction pour mettre √† jour les indicateurs de tendance
function updateTrendIndicators(data) {
    const trendElements = document.querySelectorAll('.bg-white p');
    
    // Tendance des signalements
    if (trendElements[0]) {
        const uploadsToday = data.today_uploads || 0;
        let trendText = 'En temps r√©el';
        let trendIcon = 'fas fa-minus';
        let trendColor = 'text-gray-600';
        
        if (uploadsToday > 10) {
            trendText = 'Tr√®s actif';
            trendIcon = 'fas fa-arrow-up';
            trendColor = 'text-green-600';
        } else if (uploadsToday > 5) {
            trendText = 'Activit√© normale';
            trendIcon = 'fas fa-arrow-up';
            trendColor = 'text-blue-600';
        }
        
        const trendElement = trendElements[0].querySelector('.font-medium');
        if (trendElement) {
            trendElement.innerHTML = `<i class="${trendIcon} mr-1"></i>${trendText}`;
            trendElement.className = `font-medium ${trendColor}`;
        }
    }
    
    // Tendance des poubelles pleines
    if (trendElements[1]) {
        const fullBins = data.full_bins || 0;
        let alertText = 'Surveillance active';
        let alertIcon = 'fas fa-shield-alt';
        let alertColor = 'text-green-600';
        
        if (fullBins > 10) {
            alertText = 'Alerte critique';
            alertIcon = 'fas fa-exclamation-triangle';
            alertColor = 'text-red-600';
        } else if (fullBins > 5) {
            alertText = 'Attention requise';
            alertIcon = 'fas fa-exclamation-circle';
            alertColor = 'text-orange-600';
        }
        
        const alertElement = trendElements[1].querySelector('.font-medium');
        if (alertElement) {
            alertElement.innerHTML = `<i class="${alertIcon} mr-1"></i>${alertText}`;
            alertElement.className = `font-medium ${alertColor}`;
        }
    }
    
    // Tendance de la pr√©cision IA
    if (trendElements[2]) {
        const accuracy = data.accuracy || 0;
        let aiText = 'IA en apprentissage';
        let aiIcon = 'fas fa-brain';
        let aiColor = 'text-blue-600';
        
        if (accuracy >= 90) {
            aiText = 'IA tr√®s performante';
            aiIcon = 'fas fa-star';
            aiColor = 'text-green-600';
        } else if (accuracy >= 75) {
            aiText = 'IA performante';
            aiIcon = 'fas fa-check-circle';
            aiColor = 'text-blue-600';
        } else if (accuracy < 50) {
            aiText = 'IA √† am√©liorer';
            aiIcon = 'fas fa-exclamation-triangle';
            aiColor = 'text-orange-600';
        }
        
        const aiElement = trendElements[2].querySelector('.font-medium');
        if (aiElement) {
            aiElement.innerHTML = `<i class="${aiIcon} mr-1"></i>${aiText}`;
            aiElement.className = `font-medium ${aiColor}`;
        }
    }
}

// Fonction pour mettre √† jour le graphique
function updateChart(monthlyData) {
    if (!window.statsChart) {
        console.warn('‚ö†Ô∏è Graphique non initialis√©, tentative d\'initialisation...');
        initChart();
        return;
    }
    
    console.log('üìà Mise √† jour du graphique avec:', monthlyData);
    
    // Pr√©parer les donn√©es pour Chart.js
    const months = [
        'Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun',
        'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'
    ];
    
    // Initialiser les donn√©es pour tous les mois
    const emptyData = new Array(12).fill(0);
    const fullData = new Array(12).fill(0);
    const totalData = new Array(12).fill(0);
    
    // Remplir avec les donn√©es re√ßues
    if (monthlyData && Array.isArray(monthlyData)) {
        monthlyData.forEach(item => {
            const monthIndex = parseInt(item[0]) - 1; // item[0] est le mois (1-12)
            if (monthIndex >= 0 && monthIndex < 12) {
                totalData[monthIndex] = item[1] || 0;  // total
                emptyData[monthIndex] = item[2] || 0;  // empty
                fullData[monthIndex] = item[3] || 0;   // full
            }
        });
    }
    
    // Mettre √† jour les donn√©es du graphique
    window.statsChart.data.labels = months;
    window.statsChart.data.datasets[0].data = totalData;
    window.statsChart.data.datasets[1].data = emptyData;
    window.statsChart.data.datasets[2].data = fullData;
    
    // Redessiner le graphique
    window.statsChart.update('active');
    
    console.log('‚úÖ Graphique mis √† jour');
}

// Fonction pour initialiser le graphique (si pas encore fait)
function initChart() {
    const ctx = document.getElementById('statsChart');
    if (!ctx) {
        console.error('‚ùå Element canvas #statsChart non trouv√©');
        return;
    }
    console.log('üìà Initialisation du graphique...');
    // D√©truire le graphique existant s'il y en a un
    if (window.statsChart && typeof window.statsChart.destroy === 'function') {
        window.statsChart.destroy();
    }
    window.statsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun',
                'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'],
            datasets: [
                {
                    label: 'Total signalements',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Poubelles vides',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'Poubelles pleines',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: '√âvolution mensuelle des signalements',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} signalement(s)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Nombre de signalements'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mois'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
    console.log('‚úÖ Graphique initialis√©');
}



// Fonction pour charger les derniers signalements depuis l'API
function loadRecentReports(page = 1) {
    console.log(`üìã Chargement des derniers signalements (page ${page})...`);
    
    fetch(`/api/recent_reports?page=${page}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('üìã Signalements re√ßus:', data);
            
            // Mettre √† jour le tableau des signalements
            updateReportsTable(data.reports);
            
            // NOUVEAU: Mettre √† jour les contr√¥les de pagination
            renderPaginationControls(data.pagination);
            
            console.log('‚úÖ Derniers signalements mis √† jour avec succ√®s');
        })
        .catch(error => {
            console.error('‚ùå Erreur lors du chargement des signalements:', error);
            
            // Afficher un message d'erreur dans le tableau
            showReportsError('Erreur lors du chargement des signalements');
        });
}

// Fonction pour mettre √† jour le tableau des signalements
function updateReportsTable(reports) {
    const tbody = document.querySelector('#recent-reports-table tbody');
    const noReportsDiv = document.getElementById('no-reports');
    
    if (!tbody) {
        console.error('‚ùå √âl√©ment tbody non trouv√©');
        return;
    }
    
    // Vider le tableau existant
    tbody.innerHTML = '';
    
    if (!reports || reports.length === 0) {
        // Afficher le message "aucun signalement"
        if (noReportsDiv) {
            noReportsDiv.style.display = 'block';
        }
        console.log('‚ÑπÔ∏è Aucun signalement √† afficher');
        return;
    }
    
    // Masquer le message "aucun signalement"
    if (noReportsDiv) {
        noReportsDiv.style.display = 'none';
    }
    
    // Cr√©er les lignes du tableau
    reports.forEach((report, index) => {
        const row = createReportRow(report, index);
        tbody.appendChild(row);
    });
    
    console.log(`‚úÖ ${reports.length} signalement(s) affich√©(s) dans le tableau`);
}

// NOUVEAU: Fonction pour cr√©er les contr√¥les de pagination
function renderPaginationControls(pagination) {
    const { current_page, total_pages, total_reports, limit } = pagination;
    const container = document.getElementById('pagination-controls');
    if (!container) return;

    if (total_pages <= 1) {
        container.innerHTML = '';
        return;
    }

    const startItem = (current_page - 1) * limit + 1;
    const endItem = Math.min(startItem + limit - 1, total_reports);

    let html = `
        <div class="flex-1 flex justify-between sm:hidden">
            <button onclick="loadRecentReports(${current_page - 1})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" ${current_page === 1 ? 'disabled' : ''}>
                Pr√©c√©dent
            </button>
            <button onclick="loadRecentReports(${current_page + 1})" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" ${current_page === total_pages ? 'disabled' : ''}>
                Suivant
            </button>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700">
                    Affichage de
                    <span class="font-medium">${startItem}</span>
                    √†
                    <span class="font-medium">${endItem}</span>
                    sur
                    <span class="font-medium">${total_reports}</span>
                    r√©sultats
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                    <button onclick="loadRecentReports(${current_page - 1})" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" ${current_page === 1 ? 'disabled' : ''}>
                        <span class="sr-only">Pr√©c√©dent</span>
                        <i class="fas fa-chevron-left h-5 w-5"></i>
                    </button>
    `;

    // Logique pour afficher les num√©ros de page (simplifi√©e)
    for (let i = 1; i <= total_pages; i++) {
        if (i === current_page) {
            html += `<button aria-current="page" class="z-10 bg-green-50 border-green-500 text-green-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">${i}</button>`;
        } else {
            html += `<button onclick="loadRecentReports(${i})" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">${i}</button>`;
        }
    }

    html += `
                    <button onclick="loadRecentReports(${current_page + 1})" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50" ${current_page === total_pages ? 'disabled' : ''}>
                        <span class="sr-only">Suivant</span>
                        <i class="fas fa-chevron-right h-5 w-5"></i>
                    </button>
                </nav>
            </div>
        </div>
    `;
    container.innerHTML = html;
}


// Fonction pour cr√©er une ligne de signalement
function createReportRow(report, index) {
    const row = document.createElement('tr');
    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
    row.dataset.reportId = report.id;

    // D√©terminer la couleur du statut
    const statusColor = getStatusColor(report.status);
    const statusIcon = getStatusIcon(report.status);
    
    row.innerHTML = `
        <!-- Image -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                ${report.image_url ? `
                    <img class="h-12 w-12 rounded-lg object-cover border cursor-pointer hover:scale-105 transition-transform" 
                         src="${report.image_url}" 
                         alt="Image ${report.filename}"
                         onclick="viewImageDetails(${report.id})">
                ` : `
                    <div class="h-12 w-12 rounded-lg bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>
                `}
                <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">
                        ${report.filename || 'Image inconnue'}
                    </div>
                    <div class="text-sm text-gray-500">
                        ID: ${report.id}
                    </div>
                </div>
            </div>
        </td>
        
        <!-- Localisation -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">
                <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>
                ${report.location || 'Non sp√©cifi√©e'}
            </div>
            <div class="text-sm text-gray-500">
                ${report.bin_type || 'Type standard'}
            </div>
        </td>
        
        <!-- Statut -->
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                <i class="${statusIcon} mr-1"></i>
                ${capitalizeFirst(report.status)}
            </span>
        </td>
        
        <!-- Date -->
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            <div class="flex items-center">
                <i class="fas fa-clock text-gray-400 mr-1"></i>
                ${report.date}
            </div>
        </td>
        
        <!-- Actions -->
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
                <button onclick="viewImageDetails(${report.id})" 
                        class="text-blue-600 hover:text-blue-900 transition-colors"
                        title="Voir les d√©tails">
                    <i class="fas fa-eye"></i>
                </button>
                
                ${report.status !== 'pleine' && report.status !== 'vide' ? `
                    <button onclick="annotateFromTable(${report.id}, 'pleine')" 
                    <button onclick="annotateFromTable(${report.id}, 'vide')" 
                            class="text-green-600 hover:text-green-900 transition-colors"
                            title="Marquer comme vide">
                        <i class="fas fa-check-circle"></i>
                    </button>
                ` : ''}
                
                <button onclick="deleteReport(${report.id})" 
                        class="text-gray-400 hover:text-red-600 transition-colors"
                        title="Supprimer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Fonction pour obtenir la couleur du statut
function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return 'bg-red-100 text-red-800';
        case 'vide':
            return 'bg-green-100 text-green-800';
        case 'non class√©e':
        case 'inconnu':
            return 'bg-gray-100 text-gray-800';
        default:
            return 'bg-yellow-100 text-yellow-800';
    }
}

// Fonction pour obtenir l'ic√¥ne du statut
function getStatusIcon(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return 'fas fa-exclamation-triangle';
        case 'vide':
            return 'fas fa-check-circle';
        case 'non class√©e':
        case 'inconnu':
            return 'fas fa-question-circle';
        default:
            return 'fas fa-clock';
    }
}

// Fonction utilitaire pour capitaliser la premi√®re lettre
function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Fonction pour afficher une erreur dans le tableau
function showReportsError(message) {
    const tbody = document.querySelector('tbody');
    const noReportsDiv = document.getElementById('no-reports');
    
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center">
                    <div class="text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">${message}</p>
                        <button onclick="loadRecentReports()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                            R√©essayer
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    if (noReportsDiv) {
        noReportsDiv.style.display = 'none';
    }
}

// Fonction pour voir les d√©tails d'une image
function viewImageDetails(imageId) {
    console.log(`üëÅÔ∏è Affichage des d√©tails pour l'image ID: ${imageId}`);
    
    fetch(`/api/image/${imageId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(imageData => {
            console.log('üìä D√©tails de l\'image re√ßus:', imageData);
            showImageDetailsModal(imageData);
        })
        .catch(error => {
            console.error('‚ùå Erreur lors du chargement des d√©tails:', error);
            showErrorMessage('Erreur lors du chargement des d√©tails de l\'image');
        });
}

// Fonction pour afficher la modal des d√©tails d'image
function showImageDetailsModal(imageData) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
            <!-- En-t√™te -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    D√©tails du signalement
                </h3>
                <button onclick="closeModal(this)" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Image -->
            <div class="mb-6 text-center">
                <img src="${imageData.image_url}" class="max-w-full max-h-64 mx-auto rounded-lg border shadow-sm" alt="Image du signalement">
            </div>
            
            <!-- Informations principales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-800">üìã Informations g√©n√©rales</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">ID :</span>
                            <span class="font-medium">${imageData.id}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Fichier :</span>
                            <span class="font-medium">${imageData.filename || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date :</span>
                            <span class="font-medium">${new Date(imageData.upload_date).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Localisation :</span>
                            <span class="font-medium">${imageData.location || 'Non sp√©cifi√©e'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Type de poubelle :</span>
                            <span class="font-medium">${imageData.bin_type || 'Standard'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-800">ü§ñ Classifications</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">IA :</span>
                            <span class="font-medium">${imageData.auto_classification || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Utilisateur :</span>
                            <span class="font-medium">${imageData.user_annotation || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Manuelle :</span>
                            <span class="font-medium">${imageData.manual_annotation || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Confiance :</span>
                            <span class="font-medium">${imageData.confidence ? (imageData.confidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Caract√©ristiques techniques -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600 block">Dimensions :</span>
                        <span class="font-medium">${imageData.width || 0} √ó ${imageData.height || 0} px</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Taille :</span>
                        <span class="font-medium">${imageData.file_size ? (imageData.file_size / 1024).toFixed(1) + ' Ko' : 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Luminosit√© :</span>
                        <span class="font-medium">${imageData.brightness ? imageData.brightness.toFixed(1) : 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Contraste :</span>
                        <span class="font-medium">${imageData.contrast_level ? imageData.contrast_level.toFixed(1) : 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Commentaire -->
            ${imageData.comment ? `
            <div class="bg-yellow-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-2 text-gray-800">üí¨ Commentaire</h4>
                <p class="text-sm text-gray-700">${imageData.comment}</p>
            </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="annotateFromTable(${imageData.id}, 'pleine')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-times mr-2"></i>Marquer pleine
                </button>
                <button onclick="annotateFromTable(${imageData.id}, 'vide')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-check mr-2"></i>Marquer vide
                </button>
                <button onclick="closeModal(this)" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Fonction pour annoter depuis le tableau
function annotateFromTable(imageId, annotation) {
    console.log(`üìù Annotation depuis le tableau: ID ${imageId} -> ${annotation}`);
    
    fetch(`/annotate/${imageId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`‚úÖ Image ${imageId} annot√©e comme "${annotation}"`);
                
                // Rafra√Æchir les donn√©es
                loadRecentReports();
                loadStats();
                loadMapData();
                
                // Fermer la modal si elle est ouverte
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur annotation:', error);
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

// Fonction pour supprimer un signalement (optionnelle)
function deleteReport(imageId) {

    if (confirm('√ätes-vous s√ªr de vouloir supprimer ce signalement ?')) {
        console.log(`üóëÔ∏è Suppression du signalement ID: ${imageId}`);
        
        fetch(`/api/delete_image/${imageId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('‚úÖ Signalement supprim√© avec succ√®s');
                loadRecentReports();
                loadStats();
                loadMapData();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur suppression:', error);
            showErrorMessage('Erreur lors de la suppression: ' + error.message);
        });
    }
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Page charg√©e - Initialisation...');
    
    // Test de connexion serveur
    fetch('/test')
        .then(response => response.json())
        .then(data => {
            console.log('‚úÖ Test serveur r√©ussi:', data);
            showSuccessMessage('‚úÖ Connexion serveur √©tablie');
        })
        .catch(error => {
            console.error('‚ùå Test serveur √©chou√©:', error);
            showErrorMessage('‚ùå Probl√®me de connexion au serveur');
        });
    
    initMap();
    initChart();
    loadStats();
    loadRecentReports(1); // MODIFI√â
    
    // Attacher les √©v√©nements de drag and drop
    attachDragAndDropEvents();
    
    // Event listener pour le bouton submit principal
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('üîò Bouton submit principal cliqu√©');
            
            if (window.currentFile) {
                // Si une image est en preview, l'uploader directement
                uploadCurrentImage();
            } else {
                // Sinon, v√©rifier s'il y a une image dans l'input
                const fileInput = document.getElementById('file-input');
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    handleFiles(fileInput.files);
                } else {
                    showErrorMessage('‚ö†Ô∏è Veuillez d\'abord s√©lectionner une image.');
                }
            }
        });
        console.log('‚úÖ Event listener submit attach√©');
    }
    
    // Actualiser les donn√©es p√©riodiquement
    setInterval(() => {
        loadStats();
        loadRecentReports(1);
    }, 30000);
    
    // Scroll smooth pour les boutons du hero
    const scrollReportBtn = document.getElementById('scroll-report-btn');
    const scrollMapBtn = document.getElementById('scroll-map-btn');
    if (scrollReportBtn) {
        scrollReportBtn.addEventListener('click', function() {
            const section = document.getElementById('signalement-section');
            if (section) section.scrollIntoView({ behavior: 'smooth' });
        });
    }
    if (scrollMapBtn) {
        scrollMapBtn.addEventListener('click', function() {
            const section = document.getElementById('map-section');
            if (section) section.scrollIntoView({ behavior: 'smooth' });
        });
    }

    // --- NOUVEAU: Logique pour les raccourcis clavier du tableau de bord ---
    let selectedReportIndex = -1;
    let reportRows = [];

    function updateSelection(newIndex) {
        const tableBody = document.querySelector('#recent-reports-table tbody');
        if (!tableBody) return;
        reportRows = Array.from(tableBody.querySelectorAll('tr'));

        if (reportRows.length === 0) return;

        // Remove highlight from old selection
        if (selectedReportIndex !== -1 && reportRows[selectedReportIndex]) {
            reportRows[selectedReportIndex].classList.remove('selected-row');
        }

        // Clamp the index to be within bounds
        if (newIndex < 0) newIndex = 0;
        if (newIndex >= reportRows.length) newIndex = reportRows.length - 1;

        selectedReportIndex = newIndex;

        // Add highlight to new selection
        const selectedRow = reportRows[selectedReportIndex];
        if (selectedRow) {
            selectedRow.classList.add('selected-row');
            selectedRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }

    document.addEventListener('keydown', (e) => {
        const isModalOpen = !!document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
        const isTyping = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

        if (e.key === 'Escape' && isModalOpen) {
            const modal = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-50');
            if (modal) modal.remove();
            e.preventDefault();
            return;
        }

        if (isTyping) return;

        const hasSelection = selectedReportIndex !== -1 && reportRows[selectedReportIndex];
        let reportId = null;
        if (hasSelection) {
            reportId = reportRows[selectedReportIndex].dataset.reportId;
        }

        switch(e.key.toLowerCase()) {
            case 'arrowdown':
            case '‚Üí':
                updateSelection(selectedReportIndex + 1);
                e.preventDefault();
                break;
            case 'arrowup':
            case '‚Üê':
                updateSelection(selectedReportIndex - 1);
                e.preventDefault();
                break;
            case 'f':
                if (hasSelection) {
                    annotateFromTable(reportId, 'pleine');
                    showSuccessMessage(`Signalement #${reportId} marqu√© "Pleine"`);
                    e.preventDefault();
                }
                break;
            case 'e':
                if (hasSelection) {
                    annotateFromTable(reportId, 'vide');
                    showSuccessMessage(`Signalement #${reportId} marqu√© "Vide"`);
                    e.preventDefault();
                }
                break;
            case 'm':
                if (hasSelection) {
                    viewImageDetails(reportId);
                    e.preventDefault();
                }
                break;
        }
    });

    // Attacher les √©v√©nements de clic pour la s√©lection
    const reportsTableBody = document.querySelector('#recent-reports-table tbody');
    if (reportsTableBody) {
        reportsTableBody.addEventListener('click', (e) => {
            const clickedRow = e.target.closest('tr');
            if (clickedRow) {
                const tableBody = clickedRow.parentElement;
                const allRows = Array.from(tableBody.querySelectorAll('tr'));
                const rowIndex = allRows.findIndex(row => row === clickedRow);
                updateSelection(rowIndex);
            }
        });
    }
    // --- FIN: Logique pour les raccourcis clavier ---

    // --- NOUVEAU: Logique pour la v√©rification de l'int√©grit√© ---
    const verifyBtn = document.getElementById('verify-integrity-btn');
    const reportContainer = document.getElementById('integrity-report-container');

    if (verifyBtn) {
        verifyBtn.addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>V√©rification en cours...`;
            reportContainer.innerHTML = '';
            reportContainer.classList.add('hidden');

            fetch('/api/verify_integrity')
                .then(response => response.json())
                .then(report => {
                    displayIntegrityReport(report);
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors de la v√©rification:', error);
                    reportContainer.innerHTML = `<div class="text-red-500">Erreur lors de la communication avec le serveur.</div>`;
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = `<i class="fas fa-shield-alt mr-2"></i>Relancer la v√©rification`;
                });
        });
    }

    function displayIntegrityReport(report) {
        reportContainer.classList.remove('hidden');
        const summary = report.summary;
        const issuesFound = summary.missing_files_count + summary.orphaned_files_count + summary.invalid_json_count + summary.invalid_confidence_count;

        let html = `
            <div class="p-4 rounded-lg ${issuesFound > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'} border">
                <h4 class="font-bold text-lg ${issuesFound > 0 ? 'text-red-800' : 'text-green-800'} mb-3">
                    <i class="fas ${issuesFound > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>
                    Rapport de conformit√©
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                    <div><span class="font-bold text-2xl">${summary.total_db_records}</span><p class="text-sm text-gray-600">Images en BDD</p></div>
                    <div><span class="font-bold text-2xl text-red-600">${summary.missing_files_count}</span><p class="text-sm text-gray-600">Fichiers Manquants</p></div>
                    <div><span class="font-bold text-2xl text-orange-600">${summary.orphaned_files_count}</span><p class="text-sm text-gray-600">Fichiers Orphelins</p></div>
                    <div><span class="font-bold text-2xl text-yellow-600">${summary.invalid_json_count}</span><p class="text-sm text-gray-600">Donn√©es Invalides</p></div>
                </div>
        `;

        if (issuesFound > 0) {
            html += '<div class="space-y-2 text-sm">';
            if(report.missing_files.length > 0) html += `<div><strong>Fichiers manquants:</strong> ${report.missing_files.map(f => `ID ${f.id}`).join(', ')}</div>`;
            if(report.orphaned_files.length > 0) html += `<div><strong>Fichiers orphelins:</strong> ${report.orphaned_files.map(f => f.split('/').pop()).join(', ')}</div>`;
            if(report.invalid_json_features.length > 0) html += `<div><strong>JSON invalides:</strong> ${report.invalid_json_features.map(f => `ID ${f.id}`).join(', ')}</div>`;
            html += '</div>';
        } else {
            html += '<p class="text-green-700 font-medium text-center">‚úÖ Aucune anomalie d√©tect√©e. La base de donn√©es est saine !</p>';
        }

        html += '</div>';
        reportContainer.innerHTML = html;
    }

    // --- NOUVEAU: Logique pour l'importation en masse ---
    const importBtn = document.getElementById('batch-import-btn');
    const importReportContainer = document.getElementById('batch-import-report-container');

    if (importBtn) {
        importBtn.addEventListener('click', function() {
            if (!confirm("Cette action peut prendre plusieurs minutes et importer des centaines d'images. √ätes-vous s√ªr de vouloir continuer ?")) {
                return;
            }

            this.disabled = true;
            this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Importation en cours...`;
            importReportContainer.innerHTML = '';

            fetch('/api/batch_import', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayImportReport(data.report);
                        showSuccessMessage('Importation en masse termin√©e !');
                        // Le rafra√Æchissement se fera via WebSocket
                    } else {
                        throw new Error(data.error || 'Une erreur inconnue est survenue.');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors de l\'importation en masse:', error);
                    showErrorMessage(`Erreur d'importation: ${error.message}`);
                    importReportContainer.innerHTML = `<div class="text-red-500">√âchec de l'importation.</div>`;
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = `<i class="fas fa-file-import mr-2"></i>Relancer l'importation`;
                });
        });
    }

    function displayImportReport(report) {
        const issuesFound = report.failed > 0;
        let html = `
            <div class="p-4 rounded-lg text-sm ${issuesFound ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'} border">
                <h4 class="font-bold mb-2 ${issuesFound ? 'text-red-800' : 'text-green-800'}">Rapport d'importation</h4>
                <div class="space-y-1">
                    <div><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>Import√©s :</strong> ${report.imported}</div>
                    <div><i class="fas fa-redo text-gray-500 mr-2"></i><strong>Ignor√©s (doublons) :</strong> ${report.skipped}</div>
                    <div><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i><strong>√âchecs :</strong> ${report.failed}</div>
                </div>
            </div>
        `;
        importReportContainer.innerHTML = html;
    }

    // --- NOUVEAU: Logique pour la r√©-analyse compl√®te ---
    const reclassifyBtn = document.getElementById('reclassify-btn');
    const reclassifyReportContainer = document.getElementById('reclassify-report-container');

    if (reclassifyBtn) {
        reclassifyBtn.addEventListener('click', function() {
            if (!confirm("Cette action va r√©-analyser TOUTES les images de la base de donn√©es. Cela peut prendre du temps. Continuer ?")) {
                return;
            }

            this.disabled = true;
            this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>R√©-analyse en cours...`;
            reclassifyReportContainer.innerHTML = '';

            fetch('/api/reclassify_all', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayReclassifyReport(data.report);
                        showSuccessMessage('R√©-analyse compl√®te termin√©e !');
                    } else {
                        throw new Error(data.error || 'Une erreur inconnue est survenue.');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors de la r√©-analyse:', error);
                    showErrorMessage(`Erreur de r√©-analyse: ${error.message}`);
                    reclassifyReportContainer.innerHTML = `<div class="text-red-500">√âchec de la r√©-analyse.</div>`;
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = `<i class="fas fa-sync-alt mr-2"></i>Relancer la r√©-analyse`;
                });
        });
    }

    function displayReclassifyReport(report) {
        const issuesFound = report.failed > 0 || report.not_found > 0;
        let html = `
            <div class="p-4 rounded-lg text-sm ${issuesFound ? 'bg-yellow-50 border-yellow-200' : 'bg-green-50 border-green-200'} border">
                <h4 class="font-bold mb-2 ${issuesFound ? 'text-yellow-800' : 'text-green-800'}">Rapport de r√©-analyse</h4>
                <div class="space-y-1">
                    <div><i class="fas fa-check-circle text-green-600 mr-2"></i><strong>R√©-analys√©es :</strong> ${report.reclassified}</div>
                    <div><i class="fas fa-question-circle text-gray-500 mr-2"></i><strong>Fichiers non trouv√©s :</strong> ${report.not_found}</div>
                    <div><i class="fas fa-exclamation-triangle text-red-600 mr-2"></i><strong>√âchecs :</strong> ${report.failed}</div>
                </div>
            </div>
        `;
        reclassifyReportContainer.innerHTML = html;
    }

    // --- FIN: Logique de v√©rification ---

    // --- NOUVEAU: Logique pour la suppression de toutes les images ---
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const deleteAllReportContainer = document.getElementById('delete-all-report-container');

    if (deleteAllBtn) {
        deleteAllBtn.addEventListener('click', function() {
            if (!confirm("√ätes-vous s√ªr de vouloir supprimer toutes les images et leurs donn√©es de la base de donn√©es et du serveur ? Cette action est irr√©versible.")) {
                return;
            }

            this.disabled = true;
            this.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Suppression en cours...`;
            deleteAllReportContainer.innerHTML = '';

            fetch('/api/delete_all_images', { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayDeleteAllReport(data.report);
                        showSuccessMessage('Toutes les images et leurs donn√©es ont √©t√© supprim√©es avec succ√®s !');
                    } else {
                        throw new Error(data.error || 'Une erreur inconnue est survenue.');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Erreur lors de la suppression:', error);
                    showErrorMessage(`Erreur lors de la suppression: ${error.message}`);
                    deleteAllReportContainer.innerHTML = `<div class="text-red-500">√âchec de la suppression.</div>`;
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = `<i class="fas fa-trash-alt mr-2"></i>Supprimer toutes les images`;
                });
        });
    }

    function displayDeleteAllReport(report) {
        deleteAllReportContainer.classList.remove('hidden');
        const summary = report.summary;
        const issuesFound = summary.deleted_images_count + summary.deleted_data_count;

        let html = `
            <div class="p-4 rounded-lg ${issuesFound > 0 ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'} border">
                <h4 class="font-bold text-lg ${issuesFound > 0 ? 'text-red-800' : 'text-green-800'} mb-3">
                    <i class="fas ${issuesFound > 0 ? 'fa-exclamation-triangle' : 'fa-check-circle'} mr-2"></i>
                    Rapport de suppression
                </h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center mb-4">
                    <div><span class="font-bold text-2xl">${summary.total_images}</span><p class="text-sm text-gray-600">Images supprim√©es</p></div>
                    <div><span class="font-bold text-2xl text-red-600">${summary.deleted_images_count}</span><p class="text-sm text-gray-600">Images supprim√©es</p></div>
                    <div><span class="font-bold text-2xl text-orange-600">${summary.deleted_data_count}</span><p class="text-sm text-gray-600">Donn√©es supprim√©es</p></div>
                </div>
        `;

        if (issuesFound > 0) {
            html += '<div class="space-y-2 text-sm">';
            if(report.deleted_images.length > 0) html += `<div><strong>Images supprim√©es:</strong> ${report.deleted_images.map(i => `ID ${i.id}`).join(', ')}</div>`;
            if(report.deleted_data.length > 0) html += `<div><strong>Donn√©es supprim√©es:</strong> ${report.deleted_data.map(d => `ID ${d.id}`).join(', ')}</div>`;
            html += '</div>';
        } else {
            html += '<p class="text-green-700 font-medium text-center">‚úÖ Aucune image supprim√©e. La base de donn√©es est saine !</p>';
        }

        html += '</div>';
        deleteAllReportContainer.innerHTML = html;
    }
    // --- FIN: Logique pour la suppression de toutes les images ---

    // --- NOUVEAU: Logique pour le s√©lecteur de mode de classification ---
    const classifierModeSelect = document.getElementById('classifier-mode-select');
    const classifierModeStatus = document.getElementById('classifier-mode-status');

    function updateClassifierModeUI(mode) {
        if (classifierModeSelect) classifierModeSelect.value = mode;
        if (classifierModeStatus) {
            classifierModeStatus.textContent = mode === 'ia' ?
                'Mode actuel : IA (Intelligence Artificielle)' :
                'Mode actuel : R√®gles (logique experte)';
        }
    }

    function fetchClassifierMode() {
        fetch('/api/classifier_mode')
            .then(res => res.json())
            .then(data => {
                if (data.mode) updateClassifierModeUI(data.mode);
            });
    }

    if (classifierModeSelect) {
        classifierModeSelect.addEventListener('change', function() {
            const mode = this.value;
            fetch('/api/classifier_mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateClassifierModeUI(data.mode);
                    updateAutoClassifyLabel(data.mode); // MAJ en temps r√©el du label IA/R√®gles dans le select d'√©tat
                    showSuccessMessage('Mode de classification mis √† jour : ' + (data.mode === 'ia' ? 'IA' : 'R√®gles'));
                } else {
                    showErrorMessage('Erreur lors du changement de mode : ' + (data.error || 'inconnu'));
                }
            })
            .catch(err => {
                showErrorMessage('Erreur lors du changement de mode : ' + err.message);
            });
        });
        // Initial fetch
        fetchClassifierMode();
    }
    // --- FIN: Logique pour le s√©lecteur de mode de classification ---

    // --- NOUVEAU: Mise √† jour dynamique du label IA/R√®gles dans le select d'√©tat ---
    function updateAutoClassifyLabel(mode) {
        const autoOption = document.getElementById('auto-classify-option');
        const autoHelp = document.getElementById('auto-classify-help');
        if (autoOption) {
            if (mode === 'rules') {
                autoOption.textContent = "Laissez les r√®gles d√©cider";
                if (autoHelp) autoHelp.textContent = "Si vous ne s√©lectionnez rien, les r√®gles analyseront automatiquement l'image";
            } else {
                autoOption.textContent = "Laissez l'IA d√©cider";
                if (autoHelp) autoHelp.textContent = "Si vous ne s√©lectionnez rien, l'IA analysera automatiquement l'image";
            }
        }
    }
    // Appeler aussi lors du fetch du mode de classification
    function fetchClassifierModeAndUpdateSelect() {
        fetch('/api/classifier_mode')
            .then(res => res.json())
            .then(data => {
                if (data.mode) updateAutoClassifyLabel(data.mode);
            });
    }
    fetchClassifierModeAndUpdateSelect();
    // --- FIN: Mise √† jour dynamique du label IA/R√®gles dans le select d'√©tat ---

    // --- NOUVEAU: R√©entra√Ænement IA ---
    const retrainIaBtn = document.getElementById('retrain-ia-btn');
    if (retrainIaBtn) {
        retrainIaBtn.addEventListener('click', function() {
            retrainIaBtn.disabled = true;
            retrainIaBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Entra√Ænement en cours...';
            fetch('/api/retrain_ia', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('Mod√®le IA r√©entra√Æn√© ! Voir la console pour les m√©triques.');
                    } else {
                        showErrorMessage('Erreur : ' + (data.error || 'inconnue'));
                    }
                })
                .catch(err => {
                    showErrorMessage('Erreur : ' + err.message);
                })
                .finally(() => {
                    retrainIaBtn.disabled = false;
                    retrainIaBtn.innerHTML = '<i class="fas fa-robot mr-2"></i>R√©entra√Æner l\'IA';
                });
        });
    }
    // --- FIN: R√©entra√Ænement IA ---
});

// Fonction pour charger les donn√©es de la carte depuis l'API
function loadMapData() {
    console.log('üó∫Ô∏è Chargement des donn√©es de la carte...');
    
    fetch('/api/map_data') // MODIFI√â: Utiliser la bonne route
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(poubelles => {
            console.log('üó∫Ô∏è Donn√©es des poubelles re√ßues:', poubelles);
            
            // Mettre √† jour la carte avec les nouvelles donn√©es
            updateMapMarkers(poubelles);
            
            console.log('‚úÖ Carte mise √† jour avec succ√®s');
        })
        .catch(error => {
            console.error('‚ùå Erreur lors du chargement des donn√©es de la carte:', error);
            
            // Afficher des donn√©es par d√©faut ou un message d'erreur
            showMapError('Erreur lors du chargement des poubelles');
        });
}

// Variable globale pour stocker les marqueurs
let mapMarkers = [];

// Fonction pour mettre √† jour les marqueurs sur la carte
function updateMapMarkers(poubelles) {
    if (!map) {
        console.error('‚ùå Carte non initialis√©e');
        return;
    }
    
    // Supprimer tous les marqueurs existants
    mapMarkers.forEach(marker => {
        map.removeLayer(marker);
    });
    mapMarkers = [];
    
    if (!poubelles || poubelles.length === 0) {
        console.log('‚ÑπÔ∏è Aucune poubelle √† afficher sur la carte');
        return;
    }
    
    // Ajouter les nouveaux marqueurs
    poubelles.forEach((poubelle, index) => {
        const marker = createMapMarker(poubelle, index);
        if (marker) {
            mapMarkers.push(marker);
            marker.addTo(map);
        }
    });
    
    // Ajuster la vue de la carte pour montrer tous les marqueurs
    if (mapMarkers.length > 0) {
        const group = new L.featureGroup(mapMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    console.log(`‚úÖ ${mapMarkers.length} marqueur(s) ajout√©(s) √† la carte`);
}

// Fonction pour cr√©er un marqueur sur la carte
function createMapMarker(poubelle, index) {
    // V√©rifier si on a des coordonn√©es valides
    if (!poubelle.lat || !poubelle.lng) {
        console.warn(`‚ö†Ô∏è Coordonn√©es manquantes pour la poubelle ID ${poubelle.id}`);
        return null;
    }
    
    // D√©terminer l'ic√¥ne selon le statut
    const iconConfig = getMarkerIcon(poubelle.status);
    
    // Cr√©er l'ic√¥ne personnalis√©e
    const customIcon = L.divIcon({
        html: `
            <div class="marker-container" style="position: relative;">
                <div class="marker-icon" style="
                    width: 24px; 
                    height: 24px; 
                    background-color: ${iconConfig.color}; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                    color: white;
                    font-weight: bold;
                    ${poubelle.status === 'pleine' ? 'animation: pulse 2s infinite;' : ''}
                ">
                    <i class="${iconConfig.icon}"></i>
                </div>
                ${poubelle.status === 'pleine' ? `
                    <div style="
                        position: absolute;
                                               top: -25px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #ef4444;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 8px;
                        font-weight: bold;
                        white-space: nowrap;
                    ">URGENT</div>
                ` : ''}
            </div>
        `,
        className: 'custom-marker',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    // Cr√©er le marqueur
    const marker = L.marker([poubelle.lat, poubelle.lng], {
        icon: customIcon
    });
    
    // Cr√©er le contenu du popup
    const popupContent = createPopupContent(poubelle);
    
    // Ajouter le popup au marqueur
    marker.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'custom-popup'
    });
    
    // Ajouter un √©v√©nement de clic pour plus d'actions
    marker.on('click', function() {
        console.log(`üó∫Ô∏è Clic sur la poubelle ID: ${poubelle.id}`);
        // Le popup s'ouvre automatiquement, mais on peut ajouter d'autres actions ici
    });
    
    return marker;
}

// Fonction pour obtenir la configuration de l'ic√¥ne selon le statut
function getMarkerIcon(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return {
                color: '#ef4444',
                icon: 'fas fa-exclamation'
            };
        case 'vide':
            return {
                color: '#22c55e',
                icon: 'fas fa-check'
            };
        case 'non class√©e':
        case 'inconnu':
            return {
                color: '#6b7280',
                icon: 'fas fa-question'
            };
        default:
            return {
                color: '#f59e0b',
                icon: 'fas fa-clock'
            };
    }
}

// Fonction pour cr√©er le contenu du popup
function createPopupContent(poubelle) {
    const statusColor = poubelle.status === 'pleine' ? 'text-red-600' : 
                       poubelle.status === 'vide' ? 'text-green-600' : 'text-gray-600';
    
    const urgencyBadge = poubelle.status === 'pleine' ? 
        `<span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-semibold mb-2">
            <i class="fas fa-exclamation-triangle mr-1"></i>URGENT
        </span>` : '';
    
    return `
        <div class="popup-content p-3" style="min-width: 250px;">
            <!-- En-t√™te avec statut -->
            <div class="mb-3">
                ${urgencyBadge}
                <h3 class="font-bold text-lg text-gray-800">
                    <i class="fas fa-trash-alt mr-2"></i>Poubelle #${poubelle.id}
                </h3>
                <p class="text-sm text-gray-600">${poubelle.location || 'Localisation non sp√©cifi√©e'}</p>
            </div>
            
            <!-- Statut principal -->
            <div class="mb-3 p-2 rounded-lg ${poubelle.status === 'pleine' ? 'bg-red-50' : 'bg-green-50'}">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">√âtat actuel :</span>
                    <span class="font-semibold ${statusColor} capitalize">
                        ${poubelle.status === 'pleine' ? 'üóëÔ∏è' : '‚ú®'} ${poubelle.status}
                    </span>
                </div>
                ${poubelle.confidence ? `
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs text-gray-500">Confiance :</span>
                        <span class="text-xs font-medium">${(poubelle.confidence * 100).toFixed(0)}%</span>
                    </div>
                ` : ''}
            </div>
            
            <!-- Informations d√©taill√©es -->
            <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">
                        <i class="fas fa-clock mr-1"></i>Derni√®re mise √† jour :
                    </span>
                    <span class="font-medium">${poubelle.time}</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>Coordonn√©es :
                    </span>
                    <span class="font-medium text-xs">
                        ${poubelle.lat.toFixed(4)}, ${poubelle.lng.toFixed(4)}
                    </span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-4 flex gap-2">
                <button onclick="viewImageDetails(${poubelle.id})" 
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-2 rounded-lg transition">
                    <i class="fas fa-eye mr-1"></i>D√©tails
                </button>
                
                ${poubelle.status !== 'pleine' && poubelle.status !== 'vide' ? `
                    <button onclick="annotateFromMap(${poubelle.id}, 'pleine')" 
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded-lg transition">
                        <i class="fas fa-trash-alt mr-1"></i>Pleine
                    </button>
                    <button onclick="annotateFromMap(${poubelle.id}, 'vide')" 
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-2 rounded-lg transition">
                        <i class="fas fa-check mr-1"></i>Vide
                    </button>
                ` : ''}
            </div>
            
            ${poubelle.status === 'pleine' ? `
                <div class="mt-3 p-2 bg-red-100 border-l-4 border-red-500 rounded">
                    <p class="text-xs text-red-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Action requise :</strong> Cette poubelle doit √™tre vid√©e rapidement.
                    </p>
                </div>
            ` : ''}
        </div>
    `;
}

// Fonction pour annoter depuis la carte
function annotateFromMap(poubelleId, annotation) {
    console.log(`üìù Annotation depuis la carte: ID ${poubelleId} -> ${annotation}`);
    
    fetch(`/annotate/${poubelleId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`‚úÖ Poubelle ${poubelleId} annot√©e comme "${annotation}"`);
                
                // Rafra√Æchir toutes les donn√©es
                loadMapData();
                loadStats();
                loadRecentReports();
                
                // Fermer tous les popups ouverts
                map.closePopup();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur annotation depuis carte:', error);
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

// Fonction pour afficher une erreur sur la carte
function showMapError(message) {
    // Supprimer tous les marqueurs existants
    mapMarkers.forEach(marker => {
        map.removeLayer(marker);
    });
    mapMarkers = [];
    
    // Ajouter un marqueur d'erreur au centre de la carte
    const errorIcon = L.divIcon({
        html: `
            <div style="
                background: #ef4444;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            ">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                ${message}
            </div>
        `,
        className: 'error-marker',
        iconSize: [200, 30],
        iconAnchor: [100, 15]
    });
    
    const errorMarker = L.marker(map.getCenter(), {
        icon: errorIcon
    });
    
    errorMarker.addTo(map);
    mapMarkers.push(errorMarker);
    
    // Supprimer le marqueur d'erreur apr√®s 5 secondes
    setTimeout(() => {
        map.removeLayer(errorMarker);
        mapMarkers = mapMarkers.filter(m => m !== errorMarker);
    }, 5000);
}

// Fonction pour centrer la carte sur une poubelle sp√©cifique
function centerMapOnBin(poubelleId) {
    const marker = mapMarkers.find(m => {
        const popup = m.getPopup();
        return popup && popup.getContent().includes(`#${poubelleId}`);
    });
    
    if (marker) {
        map.setView(marker.getLatLng(), 16);
        marker.openPopup();
        console.log(`üéØ Carte centr√©e sur la poubelle ${poubelleId}`);
    } else {
        console.warn(`‚ö†Ô∏è Poubelle ${poubelleId} non trouv√©e sur la carte`);
    }
}

// Fonction pour filtrer les marqueurs par statut
function filterMapMarkers(status) {
    mapMarkers.forEach(marker => {
        const popup = marker.getPopup();
        const content = popup ? popup.getContent() : '';
        
        if (status === 'all') {
            // Afficher tous les marqueurs
            marker.setOpacity(1);
        } else {
            // Afficher seulement les marqueurs correspondant au statut
            const shouldShow = content.toLowerCase().includes(status.toLowerCase());
            marker.setOpacity(shouldShow ? 1 : 0.3);
        }
    });
    
    console.log(`üîç Filtrage des marqueurs par statut: ${status}`);
}

// Ajouter les styles CSS pour les marqueurs anim√©s
const mapStyles = document.createElement('style');
mapStyles.textContent = `
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .custom-popup .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .custom-popup .leaflet-popup-content {
        margin: 0;
        line-height: 1.4;
    }
    
    .custom-marker {
        background: transparent;
        border: none;
    }
`;
document.head.appendChild(mapStyles);

// Reste des fonctions inchang√©es (initMap, loadMapData, etc.)
// [Gardez toutes les autres fonctions comme elles sont]

// Charger la carte avec des donn√©es r√©elles
function initMap() {
    map = L.map('map').setView([-32.74044740396817, -56.00385146995099], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    loadMapData();
}

// [Continuez avec toutes les autres fonctions existantes...]
// (loadMapData, viewImageDetails, handleAction, loadRecentReports, loadStats, updateChart, initChart)

// Scroll smooth pour tous les liens du menu header et mobile
// (√† placer dans le DOMContentLoaded ou √† la fin du script)
document.querySelectorAll('a[href^="#"]').forEach(link => {
    link.addEventListener('click', function(e) {
        const targetId = this.getAttribute('href').substring(1);
        const target = document.getElementById(targetId);
        if (target) {
            e.preventDefault();
            target.scrollIntoView({ behavior: 'smooth' });
            // Fermer le menu mobile si ouvert
            const menu = document.getElementById('mobile-menu');
            if (menu && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
            }
        }
    });
});
</script>
</body>
</html>