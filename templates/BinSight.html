<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinSight - Surveillance Intelligente des Poubelles Publiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map { height: 400px; }
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .file-upload:hover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .file-upload.dragover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-empty { background-color: #4ade80; }
        .status-full { 
            background-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-trash-alt text-2xl"></i>
                <h1 class="text-2xl font-bold">BinSight</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="hover:text-green-200 font-medium">Accueil</a>
                <a href="#" class="hover:text-green-200 font-medium">Signalements</a>
                <a href="#" class="hover:text-green-200 font-medium">Statistiques</a>
                <a href="#" class="hover:text-green-200 font-medium">À propos</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg font-medium transition">
                    <i class="fas fa-user mr-2"></i>Connexion
                </button>
                <button class="md:hidden text-2xl" id="mobile-menu-button">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="md:hidden hidden bg-green-700 px-4 py-2" id="mobile-menu">
            <a href="#" class="block py-2 hover:text-green-200">Accueil</a>
            <a href="#" class="block py-2 hover:text-green-200">Signalements</a>
            <a href="#" class="block py-2 hover:text-green-200">Statistiques</a>
            <a href="#" class="block py-2 hover:text-green-200">À propos</a>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-green-500 to-green-700 text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Surveillance Intelligente des Poubelles Publiques</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Une solution innovante pour détecter l'état des poubelles et améliorer la gestion des déchets urbains
            </p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button class="bg-white text-green-700 hover:bg-gray-100 px-6 py-3 rounded-lg font-bold text-lg transition shadow-lg">
                    <i class="fas fa-upload mr-2"></i>Signaler une poubelle
                </button>
                <button class="bg-transparent border-2 border-white hover:bg-white hover:text-green-700 px-6 py-3 rounded-lg font-bold text-lg transition">
                    <i class="fas fa-map-marked-alt mr-2"></i>Voir la carte
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <!-- Upload Section -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Signaler une poubelle</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="file-upload" id="drop-area">
                    <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Déposez votre image ici</h3>
                    <p class="text-gray-500 mb-4">ou</p>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                    <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
                        <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
                    </label>
                    <p class="text-sm text-gray-500 mt-4">Formats supportés: JPG, PNG, JPEG</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Ajouter des détails</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Localisation</label>
                            <input type="text" id="location-input" placeholder="Adresse ou coordonnées GPS" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Type de poubelle</label>
                            <select id="bin-type-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option>Sélectionnez un type</option>
                                <option>Poubelle standard</option>
                                <option>Poubelle de tri</option>
                                <option>Conteneur</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">État de la poubelle</label>
                            <select id="status-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Laissez l'IA décider</option>
                                <option value="pleine">Pleine</option>
                                <option value="vide">Vide</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Si vous ne sélectionnez rien, l'IA analysera automatiquement l'image</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Commentaire (optionnel)</label>
                            <textarea id="comment-textarea" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ajoutez des détails supplémentaires..."></textarea>
                        </div>
                        <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition w-full">
                            <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section class="mb-16">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Cartographie des poubelles</h2>
                <div class="flex space-x-2">
                    <button class="bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-filter mr-2"></i>Filtrer
                    </button>
                    <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition" onclick="loadMapData()">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4">
                <div id="map" class="rounded-lg"></div>
                <div class="flex justify-center mt-4 space-x-6">
                    <div class="flex items-center">
                        <span class="status-indicator status-empty"></span>
                        <span>Vide</span>
                    </div>
                    <div class="flex items-center">
                        <span class="status-indicator status-full"></span>
                        <span>Pleine</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Statistiques et analyses</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Signalements aujourd'hui</p>
                            <h3 class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-upload text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-green-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>En temps réel
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Poubelles pleines</p>
                            <h3 class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-red-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>Surveillance active
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Taux de précision</p>
                            <h3 class="text-3xl font-bold mt-2">0%</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-brain text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-blue-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>IA en apprentissage
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <canvas id="statsChart" height="300"></canvas>
            </div>
        </section>

        <!-- Recent Reports -->
        <section>
            <h2 class="text-3xl font-bold mb-6">Derniers signalements</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localisation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Les signalements seront chargés dynamiquement -->
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-center text-gray-500" id="no-reports" style="display: none;">
                    Aucun signalement pour le moment
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i> BinSight
                    </h3>
                    <p class="text-gray-400">
                        Une solution innovante pour améliorer la gestion des déchets urbains grâce à l'intelligence artificielle.
                    </p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Liens rapides</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Accueil</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Signalements</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Statistiques</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">À propos</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ressources</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Documentation</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">API</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">FAQ</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Newsletter</h4>
                    <p class="text-gray-400 mb-4">
                        Abonnez-vous pour recevoir les dernières actualités et mises à jour.
                    </p>
                    <div class="flex">
                        <input type="email" placeholder="Votre email" class="px-4 py-2 rounded-l-lg w-full focus:outline-none text-gray-800">
                        <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-r-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-400 mb-4 md:mb-0">
                    © 2023 BinSight. Tous droits réservés.
                </p>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

<script>
let poubelles = [];
let currentImageId = null;
let map;

// Mobile menu toggle
document.getElementById('mobile-menu-button').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
});

// File upload drag and drop
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropArea.classList.add('dragover');
}

function unhighlight() {
    dropArea.classList.remove('dragover');
}

dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

// ✨ NOUVELLE FONCTION avec preview de l'image
function handleFiles(files) {
    console.log('=== HANDLE FILES APPELÉ ===');
    console.log('Nombre de fichiers:', files.length);
    
    if (files.length > 0) {
        const file = files[0];
        console.log('Fichier sélectionné:', {
            name: file.name,
            size: file.size,
            type: file.type
        });
        
        if (file.type.startsWith('image/')) {
            console.log('✅ Type de fichier valide');
            
            // 🖼️ Afficher la preview de l'image
            showImagePreview(file);
            
        } else {
            console.log('❌ Type de fichier invalide:', file.type);
            showErrorMessage('❌ Veuillez sélectionner une image valide (JPG, PNG, JPEG).');
        }
    } else {
        console.log('❌ Aucun fichier sélectionné');
        showErrorMessage('❌ Aucun fichier sélectionné.');
    }
}

// ✨ NOUVELLE FONCTION pour afficher la preview
function showImagePreview(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        dropArea.innerHTML = `
            <div class="w-full">
                <!-- Preview de l'image -->
                <div class="mb-6 text-center">
                    <img src="${e.target.result}" alt="Preview" class="max-w-full max-h-80 mx-auto rounded-lg border-2 border-gray-300 object-contain shadow-lg">
                </div>
                
                <!-- Informations sur le fichier -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">📷 Image sélectionnée</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                        <div><strong>Nom :</strong> ${file.name}</div>
                        <div><strong>Taille :</strong> ${(file.size / 1024).toFixed(1)} Ko</div>
                        <div><strong>Type :</strong> ${file.type}</div>
                        <div><strong>Dernière modification :</strong> ${new Date(file.lastModified).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="uploadCurrentImage()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                    </button>
                    <button onclick="selectNewImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-exchange-alt mr-2"></i>Changer d'image
                    </button>
                    <button onclick="cancelImageUpload()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </button>
                </div>
                
                <!-- Note d'aide -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500">
                        💡 Vérifiez que l'image est correcte avant d'envoyer le signalement
                    </p>
                </div>
            </div>
        `;
    };
    
    reader.onerror = function() {
        showErrorMessage('Erreur lors de la lecture du fichier');
        resetUploadArea();
    };
    
    reader.readAsDataURL(file);
    
    // Stocker le fichier pour l'upload ultérieur
    window.currentFile = file;
}

// ✨ NOUVELLE FONCTION pour uploader l'image après preview
function uploadCurrentImage() {
    if (!window.currentFile) {
        showErrorMessage('Aucune image sélectionnée');
        return;
    }
    
    const file = window.currentFile;
    console.log('🚀 Début upload de l\'image après preview...');
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Récupérer les valeurs des champs du formulaire
    const location = document.getElementById('location-input').value;
    const binType = document.getElementById('bin-type-select').value;
    const comment = document.getElementById('comment-textarea').value;
    const userAnnotation = document.getElementById('status-select').value;
    
    console.log('Données du formulaire:', {
        location: location,
        binType: binType,
        comment: comment,
        userAnnotation: userAnnotation
    });
    
    formData.append('location', location);
    formData.append('bin_type', binType);
    formData.append('comment', comment);
    formData.append('user_annotation', userAnnotation);
    
    // Afficher indicateur de chargement avec animation
    dropArea.innerHTML = `
        <div class="w-full text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyse en cours...</h3>
                <p class="text-gray-600 mb-4">Extraction des caractéristiques et classification IA</p>
            </div>
            
            <!-- Barre de progression animée -->
            <div class="bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                <div class="bg-green-500 h-3 rounded-full animate-pulse" style="width: 65%; animation: pulse 1.5s infinite;"></div>
            </div>
            
            <div class="text-sm text-gray-500 space-y-1">
                <p>📊 Analyse des caractéristiques visuelles...</p>
                <p>🤖 Classification automatique en cours...</p>
                <p>💾 Sauvegarde dans la base de données...</p>
            </div>
        </div>
    `;
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('📥 Réponse reçue:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📊 Données JSON:', data);
        
        // Restaurer l'interface
        resetUploadArea();
        
        if (data.success) {
            console.log('✅ Upload réussi !');
            
            // Afficher les résultats avec plus de détails
            showAnalysisResults(data);
            
            // Rafraîchir toutes les données
            loadStats();
            loadRecentReports();
            loadMapData();
            
            // Réinitialiser le formulaire
            resetForm();
            
            // Nettoyer le fichier stocké
            window.currentFile = null;
            
            // Message de succès personnalisé
            const confidence = data.confidence || '0%';
            const statusEmoji = data.classification === 'pleine' ? '🗑️' : '✨';
            showSuccessMessage(`${statusEmoji} Signalement envoyé ! Poubelle classée comme "${data.classification}" (Confiance: ${confidence})`);
        } else {
            console.log('❌ Erreur serveur:', data.message);
            showErrorMessage('Erreur serveur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('❌ Erreur complète:', error);
        resetUploadArea();
        
        if (error.message.includes('Failed to fetch')) {
            showErrorMessage('❌ Impossible de se connecter au serveur. Vérifiez que Flask tourne sur http://localhost:5000');
        } else if (error.message.includes('NetworkError')) {
            showErrorMessage('❌ Erreur réseau. Vérifiez votre connexion internet.');
        } else {
            showErrorMessage('❌ Erreur lors de l\'upload: ' + error.message);
        }
    });
}

// ✨ FONCTION pour annuler l'upload
function cancelImageUpload() {
    window.currentFile = null;
    resetUploadArea();
    showSuccessMessage('Upload annulé');
}

// ✨ FONCTION pour sélectionner une nouvelle image
function selectNewImage() {
    window.currentFile = null;
    resetUploadArea();
    
    // Déclencher automatiquement le sélecteur de fichier
    setTimeout(() => {
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.click();
        }
    }, 100);
}

// Fonction améliorée pour réinitialiser la zone d'upload
function resetUploadArea() {
    dropArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">Déposez votre image ici</h3>
        <p class="text-gray-500 mb-4">ou</p>
        <input type="file" id="file-input" accept="image/*" class="hidden">
        <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
            <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
        </label>
        <p class="text-sm text-gray-500 mt-4">Formats supportés: JPG, PNG, JPEG (max 16 Mo)</p>
    `;
    
    // Réattacher l'event listener au nouveau input
    const newFileInput = document.getElementById('file-input');
    if (newFileInput) {
        newFileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
    }
    
    // Réattacher les événements de drag and drop
    attachDragAndDropEvents();
}

// Fonction pour réattacher les événements drag and drop
function attachDragAndDropEvents() {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    dropArea.addEventListener('drop', handleDrop, false);
}

// Fonction pour réinitialiser le formulaire
function resetForm() {
    document.getElementById('location-input').value = '';
    document.getElementById('bin-type-select').selectedIndex = 0;
    document.getElementById('status-select').selectedIndex = 0;
    document.getElementById('comment-textarea').value = '';
}

// Fonction améliorée pour afficher un message de succès
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement après 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction améliorée pour afficher un message d'erreur
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement après 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction améliorée pour afficher les résultats d'analyse
function showAnalysisResults(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-lg w-full max-h-screen overflow-y-auto">
            <!-- En-tête avec icône de succès -->
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-3xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Analyse terminée !</h3>
                <p class="text-gray-600 mt-2">Votre signalement a été traité avec succès</p>
            </div>
            
            <!-- Image analysée -->
            <div class="mb-6">
                <img src="${data.image_url}" class="w-full h-48 object-cover rounded-lg border shadow-sm" alt="Image analysée">
            </div>
            
            <!-- Résultats principaux -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-brain mr-2 text-blue-600"></i>Résultats de l'analyse IA
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Classification :</span>
                        <span class="font-bold text-lg ${data.classification === 'pleine' ? 'text-red-600' : 'text-green-600'}">
                            ${data.classification === 'pleine' ? '🗑️' : '✨'} Poubelle ${data.classification}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Niveau de confiance :</span>
                        <span class="font-medium text-blue-600">${data.confidence}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Source :</span>
                        <span class="font-medium">${data.is_user_annotation ? '👤 Annotation utilisateur' : '🤖 Intelligence artificielle'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Détails techniques -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Détails techniques
                </h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="text-gray-600">Dimensions :</div>
                    <div class="font-medium">${data.features.width} × ${data.features.height} px</div>
                    <div class="text-gray-600">Taille du fichier :</div>
                    <div class="font-medium">${(data.features.file_size / 1024).toFixed(1)} Ko</div>
                    <div class="text-gray-600">Luminosité moyenne :</div>
                    <div class="font-medium">${data.features.brightness.toFixed(1)}</div>
                    <div class="text-gray-600">Niveau de contraste :</div>
                    <div class="font-medium">${data.features.contrast_level.toFixed(1)}</div>
                </div>
            </div>
            
            <!-- Actions de correction (seulement pour l'IA) -->
            ${!data.is_user_annotation ? `
            <div class="border-t pt-4 mb-6">
                <p class="text-sm text-gray-600 mb-3 text-center">
                    <i class="fas fa-question-circle mr-1"></i>L'IA a-t-elle correctement classifié cette image ?
                </p>
                <div class="flex gap-2">
                    <button onclick="annotateImage(${data.image_id}, 'pleine')" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition font-medium">
                        <i class="fas fa-times mr-2"></i>Non, elle est pleine
                    </button>
                    <button onclick="annotateImage(${data.image_id}, 'vide')" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-medium">
                        <i class="fas fa-check mr-2"></i>Non, elle est vide
                    </button>
                </div>
            </div>
            ` : ''}
            
            <!-- Bouton de fermeture -->
            <div class="text-center">
                <button onclick="closeModal(this)" class="bg-gray-600 text-white px-8 py-3 rounded-lg hover:bg-gray-700 transition font-medium">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    currentImageId = data.image_id;
}

// Fonction pour annoter une image
function annotateImage(imageId, annotation) {
    fetch(`/annotate/${imageId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`✅ Correction enregistrée ! L'image a été annotée comme "${annotation}"`);
                loadStats();
                loadRecentReports();
                loadMapData();
                // Fermer la modal après annotation
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

function closeModal(button) {
    const modal = button.closest('.fixed');
    modal.remove();
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Page chargée - Initialisation...');
    
    // Test de connexion serveur
    fetch('/test')
        .then(response => response.json())
        .then(data => {
            console.log('✅ Test serveur réussi:', data);
            showSuccessMessage('✅ Connexion serveur établie');
        })
        .catch(error => {
            console.error('❌ Test serveur échoué:', error);
            showErrorMessage('❌ Problème de connexion au serveur');
        });
    
    initMap();
    initChart();
    loadStats();
    loadRecentReports();
    
    // Attacher les événements de drag and drop
    attachDragAndDropEvents();
    
    // Event listener pour le bouton submit principal
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🔘 Bouton submit principal cliqué');
            
            if (window.currentFile) {
                // Si une image est en preview, l'uploader directement
                uploadCurrentImage();
            } else {
                // Sinon, vérifier s'il y a une image dans l'input
                const fileInput = document.getElementById('file-input');
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    handleFiles(fileInput.files);
                } else {
                    showErrorMessage('⚠️ Veuillez d\'abord sélectionner une image.');
                }
            }
        });
        console.log('✅ Event listener submit attaché');
    }
    
    // Actualiser les données périodiquement
    setInterval(() => {
        loadStats();
        loadRecentReports();
    }, 30000);
});

// Reste des fonctions inchangées (initMap, loadMapData, etc.)
// [Gardez toutes les autres fonctions comme elles sont]

// Charger la carte avec des données réelles
function initMap() {
    map = L.map('map').setView([48.8566, 2.3522], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    loadMapData();
}

// [Continuez avec toutes les autres fonctions existantes...]
// (loadMapData, viewImageDetails, handleAction, loadRecentReports, loadStats, updateChart, initChart)

</script>