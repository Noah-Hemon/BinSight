<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BinSight - Surveillance Intelligente des Poubelles Publiques</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map { height: 400px; }
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            border: 2px dashed #ccc;
            border-radius: 0.5rem;
            transition: all 0.3s;
        }
        .file-upload:hover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .file-upload.dragover {
            border-color: #4ade80;
            background-color: #f0fdf4;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-empty { background-color: #4ade80; }
        .status-full { 
            background-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fas fa-trash-alt text-2xl"></i>
                <h1 class="text-2xl font-bold">BinSight</h1>
            </div>
            <nav class="hidden md:flex space-x-6">
                <a href="#" class="hover:text-green-200 font-medium">Accueil</a>
                <a href="#" class="hover:text-green-200 font-medium">Signalements</a>
                <a href="#" class="hover:text-green-200 font-medium">Statistiques</a>
                <a href="#" class="hover:text-green-200 font-medium">À propos</a>
            </nav>
            <div class="flex items-center space-x-4">
                <button class="bg-green-700 hover:bg-green-800 px-4 py-2 rounded-lg font-medium transition">
                    <i class="fas fa-user mr-2"></i>Connexion
                </button>
                <button class="md:hidden text-2xl" id="mobile-menu-button">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
        <!-- Mobile menu -->
        <div class="md:hidden hidden bg-green-700 px-4 py-2" id="mobile-menu">
            <a href="#" class="block py-2 hover:text-green-200">Accueil</a>
            <a href="#" class="block py-2 hover:text-green-200">Signalements</a>
            <a href="#" class="block py-2 hover:text-green-200">Statistiques</a>
            <a href="#" class="block py-2 hover:text-green-200">À propos</a>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-green-500 to-green-700 text-white py-16">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-4xl font-bold mb-4">Surveillance Intelligente des Poubelles Publiques</h2>
            <p class="text-xl mb-8 max-w-3xl mx-auto">
                Une solution innovante pour détecter l'état des poubelles et améliorer la gestion des déchets urbains
            </p>
            <div class="flex flex-col md:flex-row justify-center gap-4">
                <button id="scroll-report-btn" class="bg-white text-green-700 hover:bg-gray-100 px-6 py-3 rounded-lg font-bold text-lg transition shadow-lg">
                    <i class="fas fa-upload mr-2"></i>Signaler une poubelle
                </button>
                <button id="scroll-map-btn" class="bg-transparent border-2 border-white hover:bg-white hover:text-green-700 px-6 py-3 rounded-lg font-bold text-lg transition">
                    <i class="fas fa-map-marked-alt mr-2"></i>Voir la carte
                </button>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        <!-- Upload Section -->
        <section id="signalement-section" class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Signaler une poubelle</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="file-upload" id="drop-area">
                    <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">Déposez votre image ici</h3>
                    <p class="text-gray-500 mb-4">ou</p>
                    <input type="file" id="file-input" accept="image/*" class="hidden">
                    <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
                        <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
                    </label>
                    <p class="text-sm text-gray-500 mt-4">Formats supportés: JPG, PNG, JPEG</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-4">Ajouter des détails</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 mb-2">Localisation</label>
                            <input type="text" id="location-input" placeholder="Adresse ou coordonnées GPS" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Type de poubelle</label>
                            <select id="bin-type-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option>Sélectionnez un type</option>
                                <option>Poubelle standard</option>
                                <option>Poubelle de tri</option>
                                <option>Conteneur</option>
                                <option>Autre</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">État de la poubelle</label>
                            <select id="status-select" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Laissez l'IA décider</option>
                                <option value="pleine">Pleine</option>
                                <option value="vide">Vide</option>
                            </select>
                            <p class="text-sm text-gray-500 mt-1">Si vous ne sélectionnez rien, l'IA analysera automatiquement l'image</p>
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">Commentaire (optionnel)</label>
                            <textarea id="comment-textarea" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Ajoutez des détails supplémentaires..."></textarea>
                        </div>
                        <button id="submit-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition w-full">
                            <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Map Section -->
        <section id="map-section" class="mb-16">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">Cartographie des poubelles</h2>
                <div class="flex space-x-2">
                    <button class="bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-filter mr-2"></i>Filtrer
                    </button>
                    <button class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition" onclick="loadMapData()">
                        <i class="fas fa-sync-alt mr-2"></i>Actualiser
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-4">
                <div id="map" class="rounded-lg"></div>
                <div class="flex justify-center mt-4 space-x-6">
                    <div class="flex items-center">
                        <span class="status-indicator status-empty"></span>
                        <span>Vide</span>
                    </div>
                    <div class="flex items-center">
                        <span class="status-indicator status-full"></span>
                        <span>Pleine</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="mb-16">
            <h2 class="text-3xl font-bold mb-8 text-center">Statistiques et analyses</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Signalements aujourd'hui</p>
                            <h3 id="today-uploads" class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-upload text-green-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-green-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>En temps réel
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Poubelles pleines</p>
                            <h3 id="full-bins" class="text-3xl font-bold mt-2">0</h3>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-red-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>Surveillance active
                        </p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500">Taux de précision</p>
                            <h3 id="accuracy" class="text-3xl font-bold mt-2">0%</h3>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-brain text-blue-600 text-xl"></i>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-blue-600 font-medium">
                            <i class="fas fa-arrow-up mr-1"></i>IA en apprentissage
                        </p>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <canvas id="statsChart" height="300"></canvas>
            </div>
        </section>

        <!-- Recent Reports -->
        <section>
            <h2 class="text-3xl font-bold mb-6">Derniers signalements</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Localisation</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Les signalements seront chargés dynamiquement -->
                        </tbody>
                    </table>
                </div>
                <div class="bg-gray-50 px-6 py-3 text-center text-gray-500" id="no-reports" style="display: none;">
                    Aucun signalement pour le moment
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i> BinSight
                    </h3>
                    <p class="text-gray-400">
                        Une solution innovante pour améliorer la gestion des déchets urbains grâce à l'intelligence artificielle.
                    </p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Liens rapides</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Accueil</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Signalements</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Statistiques</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">À propos</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Ressources</h4>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Documentation</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">API</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">FAQ</a></li>
                        <li><a href="#" class="text-gray-400 hover:text-white transition">Contact</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Newsletter</h4>
                    <p class="text-gray-400 mb-4">
                        Abonnez-vous pour recevoir les dernières actualités et mises à jour.
                    </p>
                    <div class="flex">
                        <input type="email" placeholder="Votre email" class="px-4 py-2 rounded-l-lg w-full focus:outline-none text-gray-800">
                        <button class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-r-lg transition">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 flex flex-col md:flex-row justify-between items-center">
                <p class="text-gray-400 mb-4 md:mb-0">
                    © 2023 BinSight. Tous droits réservés.
                </p>
                <div class="flex space-x-6">
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="text-gray-400 hover:text-white transition">
                        <i class="fab fa-linkedin-in"></i>
                    </a>
                </div>
            </div>
        </div>
    </footer>

<script>
let poubelles = [];
let currentImageId = null;
let map;

// Mobile menu toggle
document.getElementById('mobile-menu-button').addEventListener('click', function() {
    const menu = document.getElementById('mobile-menu');
    menu.classList.toggle('hidden');
});

// File upload drag and drop
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, unhighlight, false);
});

function highlight() {
    dropArea.classList.add('dragover');
}

function unhighlight() {
    dropArea.classList.remove('dragover');
}

dropArea.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

fileInput.addEventListener('change', function() {
    handleFiles(this.files);
});

// ✨ NOUVELLE FONCTION avec preview de l'image
function handleFiles(files) {
    console.log('=== HANDLE FILES APPELÉ ===');
    console.log('Nombre de fichiers:', files.length);
    
    if (files.length > 0) {
        const file = files[0];
        console.log('Fichier sélectionné:', {
            name: file.name,
            size: file.size,
            type: file.type
        });
        
        if (file.type.startsWith('image/')) {
            console.log('✅ Type de fichier valide');
            
            // 🖼️ Afficher la preview de l'image
            showImagePreview(file);
            
        } else {
            console.log('❌ Type de fichier invalide:', file.type);
            showErrorMessage('❌ Veuillez sélectionner une image valide (JPG, PNG, JPEG).');
        }
    } else {
        console.log('❌ Aucun fichier sélectionné');
        showErrorMessage('❌ Aucun fichier sélectionné.');
    }
}

// ✨ NOUVELLE FONCTION pour afficher la preview
function showImagePreview(file) {
    const reader = new FileReader();
    
    reader.onload = function(e) {
        dropArea.innerHTML = `
            <div class="w-full">
                <!-- Preview de l'image -->
                <div class="mb-6 text-center">
                    <img src="${e.target.result}" alt="Preview" class="max-w-full max-h-80 mx-auto rounded-lg border-2 border-gray-300 object-contain shadow-lg">
                </div>
                
                <!-- Informations sur le fichier -->
                <div class="bg-gray-50 p-4 rounded-lg mb-6">
                    <h4 class="font-semibold text-gray-800 mb-3">📷 Image sélectionnée</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                        <div><strong>Nom :</strong> ${file.name}</div>
                        <div><strong>Taille :</strong> ${(file.size / 1024).toFixed(1)} Ko</div>
                        <div><strong>Type :</strong> ${file.type}</div>
                        <div><strong>Dernière modification :</strong> ${new Date(file.lastModified).toLocaleDateString()}</div>
                    </div>
                </div>
                
                <!-- Boutons d'action -->
                <div class="flex flex-col sm:flex-row gap-3 justify-center">
                    <button onclick="uploadCurrentImage()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-paper-plane mr-2"></i>Envoyer le signalement
                    </button>
                    <button onclick="selectNewImage()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-exchange-alt mr-2"></i>Changer d'image
                    </button>
                    <button onclick="cancelImageUpload()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg transition font-medium shadow-md">
                        <i class="fas fa-times mr-2"></i>Annuler
                    </button>
                </div>
                
                <!-- Note d'aide -->
                <div class="mt-4 text-center">
                    <p class="text-sm text-gray-500">
                        💡 Vérifiez que l'image est correcte avant d'envoyer le signalement
                    </p>
                </div>
            </div>
        `;
    };
    
    reader.onerror = function() {
        showErrorMessage('Erreur lors de la lecture du fichier');
        resetUploadArea();
    };
    
    reader.readAsDataURL(file);
    
    // Stocker le fichier pour l'upload ultérieur
    window.currentFile = file;
}

// ✨ NOUVELLE FONCTION pour uploader l'image après preview
function uploadCurrentImage() {
    if (!window.currentFile) {
        showErrorMessage('Aucune image sélectionnée');
        return;
    }
    
    const file = window.currentFile;
    console.log('🚀 Début upload de l\'image après preview...');
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Récupérer les valeurs des champs du formulaire
    const location = document.getElementById('location-input').value;
    const binType = document.getElementById('bin-type-select').value;
    const comment = document.getElementById('comment-textarea').value;
    const userAnnotation = document.getElementById('status-select').value;
    
    console.log('Données du formulaire:', {
        location: location,
        binType: binType,
        comment: comment,
        userAnnotation: userAnnotation
    });
    
    formData.append('location', location);
    formData.append('bin_type', binType);
    formData.append('comment', comment);
    formData.append('user_annotation', userAnnotation);
    
    // Afficher indicateur de chargement avec animation
    dropArea.innerHTML = `
        <div class="w-full text-center">
            <div class="mb-6">
                <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-spinner fa-spin text-3xl text-green-600"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Analyse en cours...</h3>
                <p class="text-gray-600 mb-4">Extraction des caractéristiques et classification IA</p>
            </div>
            
            <!-- Barre de progression animée -->
            <div class="bg-gray-200 rounded-full h-3 mb-4 overflow-hidden">
                <div class="bg-green-500 h-3 rounded-full animate-pulse" style="width: 65%; animation: pulse 1.5s infinite;"></div>
            </div>
            
            <div class="text-sm text-gray-500 space-y-1">
                <p>📊 Analyse des caractéristiques visuelles...</p>
                <p>🤖 Classification automatique en cours...</p>
                <p>💾 Sauvegarde dans la base de données...</p>
            </div>
        </div>
    `;
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('📥 Réponse reçue:', {
            status: response.status,
            statusText: response.statusText,
            ok: response.ok
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📊 Données JSON:', data);
        
        // Restaurer l'interface
        resetUploadArea();
        
        if (data.success) {
            console.log('✅ Upload réussi !');
            
            // Afficher les résultats avec plus de détails
            showAnalysisResults(data);
            
            // Rafraîchir toutes les données
            loadStats();
            loadRecentReports();
            loadMapData();
            
            // Réinitialiser le formulaire
            resetForm();
            
            // Nettoyer le fichier stocké
            window.currentFile = null;
            
            // Message de succès personnalisé
            const confidence = data.confidence || '0%';
            const statusEmoji = data.classification === 'pleine' ? '🗑️' : '✨';
            showSuccessMessage(`${statusEmoji} Signalement envoyé ! Poubelle classée comme "${data.classification}" (Confiance: ${confidence})`);
        } else {
            console.log('❌ Erreur serveur:', data.message);
            showErrorMessage('Erreur serveur: ' + data.message);
        }
    })
    .catch(error => {
        console.error('❌ Erreur complète:', error);
        resetUploadArea();
        
        if (error.message.includes('Failed to fetch')) {
            showErrorMessage('❌ Impossible de se connecter au serveur. Vérifiez que Flask tourne sur http://localhost:5000');
        } else if (error.message.includes('NetworkError')) {
            showErrorMessage('❌ Erreur réseau. Vérifiez votre connexion internet.');
        } else {
            showErrorMessage('❌ Erreur lors de l\'upload: ' + error.message);
        }
    });
}

// ✨ FONCTION pour annuler l'upload
function cancelImageUpload() {
    window.currentFile = null;
    resetUploadArea();
    showSuccessMessage('Upload annulé');
}

// ✨ FONCTION pour sélectionner une nouvelle image
function selectNewImage() {
    window.currentFile = null;
    resetUploadArea();
    
    // Déclencher automatiquement le sélecteur de fichier
    setTimeout(() => {
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.click();
        }
    }, 100);
}

// Fonction améliorée pour réinitialiser la zone d'upload
function resetUploadArea() {
    dropArea.innerHTML = `
        <i class="fas fa-cloud-upload-alt text-5xl text-green-500 mb-4"></i>
        <h3 class="text-xl font-semibold mb-2">Déposez votre image ici</h3>
        <p class="text-gray-500 mb-4">ou</p>
        <input type="file" id="file-input" accept="image/*" class="hidden">
        <label for="file-input" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg cursor-pointer transition">
            <i class="fas fa-folder-open mr-2"></i>Parcourir les fichiers
        </label>
        <p class="text-sm text-gray-500 mt-4">Formats supportés: JPG, PNG, JPEG (max 16 Mo)</p>
    `;
    
    // Réattacher l'event listener au nouveau input
    const newFileInput = document.getElementById('file-input');
    if (newFileInput) {
        newFileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });
    }
    
    // Réattacher les événements de drag and drop
    attachDragAndDropEvents();
}

// Fonction pour réattacher les événements drag and drop
function attachDragAndDropEvents() {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    dropArea.addEventListener('drop', handleDrop, false);
}

// Fonction pour réinitialiser le formulaire
function resetForm() {
    document.getElementById('location-input').value = '';
    document.getElementById('bin-type-select').selectedIndex = 0;
    document.getElementById('status-select').selectedIndex = 0;
    document.getElementById('comment-textarea').value = '';
}

// Fonction améliorée pour afficher un message de succès
function showSuccessMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-check-circle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement après 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction améliorée pour afficher un message d'erreur
function showErrorMessage(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    notification.innerHTML = `
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-xl mr-3"></i>
            </div>
            <div class="flex-1">
                <span class="font-medium">${message}</span>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200 flex-shrink-0">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(notification);
    
    // Animation d'entrée
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 100);
    
    // Supprimer automatiquement après 7 secondes
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => notification.remove(), 300);
        }
    }, 7000);
}

// Fonction améliorée pour afficher les résultats d'analyse
function showAnalysisResults(data) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-lg w-full max-h-screen overflow-y-auto">
            <!-- En-tête avec icône de succès -->
            <div class="text-center mb-6">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mb-4">
                    <i class="fas fa-check-circle text-3xl text-green-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Analyse terminée !</h3>
                <p class="text-gray-600 mt-2">Votre signalement a été traité avec succès</p>
            </div>
            
            <!-- Image analysée -->
            <div class="mb-6">
                <img src="${data.image_url}" class="w-full h-48 object-cover rounded-lg border shadow-sm" alt="Image analysée">
            </div>
            
            <!-- Résultats principaux -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-brain mr-2 text-blue-600"></i>Résultats de l'analyse IA
                </h4>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Classification :</span>
                        <span class="font-bold text-lg ${data.classification === 'pleine' ? 'text-red-600' : 'text-green-600'}">
                            ${data.classification === 'pleine' ? '🗑️' : '✨'} Poubelle ${data.classification}
                        </span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Niveau de confiance :</span>
                        <span class="font-medium text-blue-600">${data.confidence}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600">Source :</span>
                        <span class="font-medium">${data.is_user_annotation ? '👤 Annotation utilisateur' : '🤖 Intelligence artificielle'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Détails techniques -->
            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Détails techniques
                </h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="text-gray-600">Dimensions :</div>
                    <div class="font-medium">${data.features.width} × ${data.features.height} px</div>
                    <div class="text-gray-600">Taille du fichier :</div>
                    <div class="font-medium">${(data.features.file_size / 1024).toFixed(1)} Ko</div>
                    <div class="text-gray-600">Luminosité moyenne :</div>
                    <div class="font-medium">${data.features.brightness.toFixed(1)}</div>
                    <div class="text-gray-600">Niveau de contraste :</div>
                    <div class="font-medium">${data.features.contrast_level.toFixed(1)}</div>
                </div>
            </div>
            
            <!-- Actions de correction (seulement pour l'IA) -->
            ${!data.is_user_annotation ? `
            <div class="border-t pt-4 mb-6">
                <p class="text-sm text-gray-600 mb-3 text-center">
                    <i class="fas fa-question-circle mr-1"></i>L'IA a-t-elle correctement classifié cette image ?
                </p>
                <div class="flex gap-2">
                    <button onclick="annotateImage(${data.image_id}, 'pleine')" class="flex-1 bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700 transition font-medium">
                        <i class="fas fa-times mr-2"></i>Non, elle est pleine
                    </button>
                    <button onclick="annotateImage(${data.image_id}, 'vide')" class="flex-1 bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-medium">
                        <i class="fas fa-check mr-2"></i>Non, elle est vide
                    </button>
                </div>
            </div>
            ` : ''}
            
            <!-- Bouton de fermeture -->
            <div class="text-center">
                <button onclick="closeModal(this)" class="bg-gray-600 text-white px-8 py-3 rounded-lg hover:bg-gray-700 transition font-medium">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    currentImageId = data.image_id;
}

// Fonction pour annoter une image
function annotateImage(imageId, annotation) {
    fetch(`/annotate/${imageId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`✅ Correction enregistrée ! L'image a été annotée comme "${annotation}"`);
                loadStats();
                loadRecentReports();
                loadMapData();
                // Fermer la modal après annotation
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

function closeModal(button) {
    const modal = button.closest('.fixed');
    modal.remove();
}



// Fonction pour charger les statistiques depuis l'API
function loadStats() {
    console.log('📊 Chargement des statistiques...');
    
    fetch('/api/stats')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('📊 Statistiques reçues:', data);
            
            // Mettre à jour les cartes de statistiques
            updateStatsCards(data);
            
            // Mettre à jour le graphique
            updateChart(data.monthly_data);
            
            console.log('✅ Statistiques mises à jour avec succès');
        })
        .catch(error => {
            console.error('❌ Erreur lors du chargement des statistiques:', error);
            
            // Afficher des valeurs par défaut en cas d'erreur
            updateStatsCards({
                today_uploads: 0,
                full_bins: 0,
                accuracy: 0.0,
                monthly_data: []
            });
            
            // Optionnel : afficher un message d'erreur discret
            console.warn('Utilisation des statistiques par défaut en raison d\'une erreur');
        });
}

// Fonction pour mettre à jour les cartes de statistiques
function updateStatsCards(data) {
    // Signalements aujourd'hui
    const todayUploadsElement = document.getElementById('today-uploads');
    if (todayUploadsElement) {
        todayUploadsElement.textContent = data.today_uploads || 0;
    }
    // Poubelles pleines
    const fullBinsElement = document.getElementById('full-bins');
    if (fullBinsElement) {
        fullBinsElement.textContent = data.full_bins || 0;
        // Ajouter une animation si le nombre est élevé
        if (data.full_bins > 5) {
            fullBinsElement.classList.add('text-red-600');
            fullBinsElement.parentElement.parentElement.classList.add('border-l-4', 'border-red-500');
        } else {
            fullBinsElement.classList.remove('text-red-600');
            fullBinsElement.parentElement.parentElement.classList.remove('border-l-4', 'border-red-500');
        }
    }
    // Taux de précision
    const accuracyElement = document.getElementById('accuracy');
    if (accuracyElement) {
        const accuracy = data.accuracy || 0;
        accuracyElement.textContent = `${accuracy}%`;
        // Changer la couleur selon la précision
        if (accuracy >= 80) {
            accuracyElement.classList.add('text-green-600');
            accuracyElement.classList.remove('text-yellow-600', 'text-red-600');
        } else if (accuracy >= 60) {
            accuracyElement.classList.add('text-yellow-600');
            accuracyElement.classList.remove('text-green-600', 'text-red-600');
        } else {
            accuracyElement.classList.add('text-red-600');
            accuracyElement.classList.remove('text-green-600', 'text-yellow-600');
        }
    }
    // Mettre à jour les indicateurs de tendance
    updateTrendIndicators(data);
}

// Fonction pour mettre à jour les indicateurs de tendance
function updateTrendIndicators(data) {
    const trendElements = document.querySelectorAll('.bg-white p');
    
    // Tendance des signalements
    if (trendElements[0]) {
        const uploadsToday = data.today_uploads || 0;
        let trendText = 'En temps réel';
        let trendIcon = 'fas fa-minus';
        let trendColor = 'text-gray-600';
        
        if (uploadsToday > 10) {
            trendText = 'Très actif';
            trendIcon = 'fas fa-arrow-up';
            trendColor = 'text-green-600';
        } else if (uploadsToday > 5) {
            trendText = 'Activité normale';
            trendIcon = 'fas fa-arrow-up';
            trendColor = 'text-blue-600';
        }
        
        const trendElement = trendElements[0].querySelector('.font-medium');
        if (trendElement) {
            trendElement.innerHTML = `<i class="${trendIcon} mr-1"></i>${trendText}`;
            trendElement.className = `font-medium ${trendColor}`;
        }
    }
    
    // Tendance des poubelles pleines
    if (trendElements[1]) {
        const fullBins = data.full_bins || 0;
        let alertText = 'Surveillance active';
        let alertIcon = 'fas fa-shield-alt';
        let alertColor = 'text-green-600';
        
        if (fullBins > 10) {
            alertText = 'Alerte critique';
            alertIcon = 'fas fa-exclamation-triangle';
            alertColor = 'text-red-600';
        } else if (fullBins > 5) {
            alertText = 'Attention requise';
            alertIcon = 'fas fa-exclamation-circle';
            alertColor = 'text-orange-600';
        }
        
        const alertElement = trendElements[1].querySelector('.font-medium');
        if (alertElement) {
            alertElement.innerHTML = `<i class="${alertIcon} mr-1"></i>${alertText}`;
            alertElement.className = `font-medium ${alertColor}`;
        }
    }
    
    // Tendance de la précision IA
    if (trendElements[2]) {
        const accuracy = data.accuracy || 0;
        let aiText = 'IA en apprentissage';
        let aiIcon = 'fas fa-brain';
        let aiColor = 'text-blue-600';
        
        if (accuracy >= 90) {
            aiText = 'IA très performante';
            aiIcon = 'fas fa-star';
            aiColor = 'text-green-600';
        } else if (accuracy >= 75) {
            aiText = 'IA performante';
            aiIcon = 'fas fa-check-circle';
            aiColor = 'text-blue-600';
        } else if (accuracy < 50) {
            aiText = 'IA à améliorer';
            aiIcon = 'fas fa-exclamation-triangle';
            aiColor = 'text-orange-600';
        }
        
        const aiElement = trendElements[2].querySelector('.font-medium');
        if (aiElement) {
            aiElement.innerHTML = `<i class="${aiIcon} mr-1"></i>${aiText}`;
            aiElement.className = `font-medium ${aiColor}`;
        }
    }
}

// Fonction pour mettre à jour le graphique
function updateChart(monthlyData) {
    if (!window.statsChart) {
        console.warn('⚠️ Graphique non initialisé, tentative d\'initialisation...');
        initChart();
        return;
    }
    
    console.log('📈 Mise à jour du graphique avec:', monthlyData);
    
    // Préparer les données pour Chart.js
    const months = [
        'Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun',
        'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'
    ];
    
    // Initialiser les données pour tous les mois
    const emptyData = new Array(12).fill(0);
    const fullData = new Array(12).fill(0);
    const totalData = new Array(12).fill(0);
    
    // Remplir avec les données reçues
    if (monthlyData && Array.isArray(monthlyData)) {
        monthlyData.forEach(item => {
            const monthIndex = parseInt(item[0]) - 1; // item[0] est le mois (1-12)
            if (monthIndex >= 0 && monthIndex < 12) {
                totalData[monthIndex] = item[1] || 0;  // total
                emptyData[monthIndex] = item[2] || 0;  // empty
                fullData[monthIndex] = item[3] || 0;   // full
            }
        });
    }
    
    // Mettre à jour les données du graphique
    window.statsChart.data.labels = months;
    window.statsChart.data.datasets[0].data = totalData;
    window.statsChart.data.datasets[1].data = emptyData;
    window.statsChart.data.datasets[2].data = fullData;
    
    // Redessiner le graphique
    window.statsChart.update('active');
    
    console.log('✅ Graphique mis à jour');
}

// Fonction pour initialiser le graphique (si pas encore fait)
function initChart() {
    const ctx = document.getElementById('statsChart');
    if (!ctx) {
        console.error('❌ Element canvas #statsChart non trouvé');
        return;
    }
    console.log('📈 Initialisation du graphique...');
    // Détruire le graphique existant s'il y en a un
    if (window.statsChart && typeof window.statsChart.destroy === 'function') {
        window.statsChart.destroy();
    }
    window.statsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun',
                'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
            datasets: [
                {
                    label: 'Total signalements',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Poubelles vides',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(34, 197, 94)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: false
                },
                {
                    label: 'Poubelles pleines',
                    data: new Array(12).fill(0),
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Évolution mensuelle des signalements',
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} signalement(s)`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    },
                    title: {
                        display: true,
                        text: 'Nombre de signalements'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Mois'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutQuart'
            }
        }
    });
    console.log('✅ Graphique initialisé');
}



// Fonction pour charger les derniers signalements depuis l'API
function loadRecentReports() {
    console.log('📋 Chargement des derniers signalements...');
    
    fetch('/api/recent_reports')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(reports => {
            console.log('📋 Signalements reçus:', reports);
            
            // Mettre à jour le tableau des signalements
            updateReportsTable(reports);
            
            console.log('✅ Derniers signalements mis à jour avec succès');
        })
        .catch(error => {
            console.error('❌ Erreur lors du chargement des signalements:', error);
            
            // Afficher un message d'erreur dans le tableau
            showReportsError('Erreur lors du chargement des signalements');
        });
}

// Fonction pour mettre à jour le tableau des signalements
function updateReportsTable(reports) {
    const tbody = document.querySelector('tbody');
    const noReportsDiv = document.getElementById('no-reports');
    
    if (!tbody) {
        console.error('❌ Élément tbody non trouvé');
        return;
    }
    
    // Vider le tableau existant
    tbody.innerHTML = '';
    
    if (!reports || reports.length === 0) {
        // Afficher le message "aucun signalement"
        if (noReportsDiv) {
            noReportsDiv.style.display = 'block';
        }
        console.log('ℹ️ Aucun signalement à afficher');
        return;
    }
    
    // Masquer le message "aucun signalement"
    if (noReportsDiv) {
        noReportsDiv.style.display = 'none';
    }
    
    // Créer les lignes du tableau
    reports.forEach((report, index) => {
        const row = createReportRow(report, index);
        tbody.appendChild(row);
    });
    
    console.log(`✅ ${reports.length} signalement(s) affiché(s) dans le tableau`);
}

// Fonction pour créer une ligne de signalement
function createReportRow(report, index) {
    const row = document.createElement('tr');
    row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
    
    // Déterminer la couleur du statut
    const statusColor = getStatusColor(report.status);
    const statusIcon = getStatusIcon(report.status);
    
    row.innerHTML = `
        <!-- Image -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                ${report.image_url ? `
                    <img class="h-12 w-12 rounded-lg object-cover border cursor-pointer hover:scale-105 transition-transform" 
                         src="${report.image_url}" 
                         alt="Image ${report.filename}"
                         onclick="viewImageDetails(${report.id})">
                ` : `
                    <div class="h-12 w-12 rounded-lg bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-image text-gray-400"></i>
                    </div>
                `}
                <div class="ml-3">
                    <div class="text-sm font-medium text-gray-900">
                        ${report.filename || 'Image inconnue'}
                    </div>
                    <div class="text-sm text-gray-500">
                        ID: ${report.id}
                    </div>
                </div>
            </div>
        </td>
        
        <!-- Localisation -->
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="text-sm text-gray-900">
                <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>
                ${report.location || 'Non spécifiée'}
            </div>
            <div class="text-sm text-gray-500">
                ${report.bin_type || 'Type standard'}
            </div>
        </td>
        
        <!-- Statut -->
        <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                <i class="${statusIcon} mr-1"></i>
                ${capitalizeFirst(report.status)}
            </span>
        </td>
        
        <!-- Date -->
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            <div class="flex items-center">
                <i class="fas fa-clock text-gray-400 mr-1"></i>
                ${report.date}
            </div>
        </td>
        
        <!-- Actions -->
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex space-x-2">
                <button onclick="viewImageDetails(${report.id})" 
                        class="text-blue-600 hover:text-blue-900 transition-colors"
                        title="Voir les détails">
                    <i class="fas fa-eye"></i>
                </button>
                
                ${report.status !== 'pleine' && report.status !== 'vide' ? `
                    <button onclick="annotateFromTable(${report.id}, 'pleine')" 
                            class="text-red-600 hover:text-red-900 transition-colors"
                            title="Marquer comme pleine">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    <button onclick="annotateFromTable(${report.id}, 'vide')" 
                            class="text-green-600 hover:text-green-900 transition-colors"
                            title="Marquer comme vide">
                        <i class="fas fa-check-circle"></i>
                    </button>
                ` : ''}
                
                <button onclick="deleteReport(${report.id})" 
                        class="text-gray-400 hover:text-red-600 transition-colors"
                        title="Supprimer">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// Fonction pour obtenir la couleur du statut
function getStatusColor(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return 'bg-red-100 text-red-800';
        case 'vide':
            return 'bg-green-100 text-green-800';
        case 'non classée':
        case 'inconnu':
            return 'bg-gray-100 text-gray-800';
        default:
            return 'bg-yellow-100 text-yellow-800';
    }
}

// Fonction pour obtenir l'icône du statut
function getStatusIcon(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return 'fas fa-exclamation-triangle';
        case 'vide':
            return 'fas fa-check-circle';
        case 'non classée':
        case 'inconnu':
            return 'fas fa-question-circle';
        default:
            return 'fas fa-clock';
    }
}

// Fonction utilitaire pour capitaliser la première lettre
function capitalizeFirst(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Fonction pour afficher une erreur dans le tableau
function showReportsError(message) {
    const tbody = document.querySelector('tbody');
    const noReportsDiv = document.getElementById('no-reports');
    
    if (tbody) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-8 text-center">
                    <div class="text-red-500">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p class="text-sm">${message}</p>
                        <button onclick="loadRecentReports()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                            Réessayer
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }
    
    if (noReportsDiv) {
        noReportsDiv.style.display = 'none';
    }
}

// Fonction pour voir les détails d'une image
function viewImageDetails(imageId) {
    console.log(`👁️ Affichage des détails pour l'image ID: ${imageId}`);
    
    fetch(`/api/image/${imageId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(imageData => {
            console.log('📊 Détails de l\'image reçus:', imageData);
            showImageDetailsModal(imageData);
        })
        .catch(error => {
            console.error('❌ Erreur lors du chargement des détails:', error);
            showErrorMessage('Erreur lors du chargement des détails de l\'image');
        });
}

// Fonction pour afficher la modal des détails d'image
function showImageDetailsModal(imageData) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white p-6 rounded-lg max-w-2xl w-full max-h-screen overflow-y-auto">
            <!-- En-tête -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    Détails du signalement
                </h3>
                <button onclick="closeModal(this)" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Image -->
            <div class="mb-6 text-center">
                <img src="${imageData.image_url}" class="max-w-full max-h-64 mx-auto rounded-lg border shadow-sm" alt="Image du signalement">
            </div>
            
            <!-- Informations principales -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-800">📋 Informations générales</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">ID :</span>
                            <span class="font-medium">${imageData.id}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Fichier :</span>
                            <span class="font-medium">${imageData.filename || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Date :</span>
                            <span class="font-medium">${new Date(imageData.upload_date).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Localisation :</span>
                            <span class="font-medium">${imageData.location || 'Non spécifiée'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Type de poubelle :</span>
                            <span class="font-medium">${imageData.bin_type || 'Standard'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h4 class="font-semibold mb-3 text-gray-800">🤖 Classifications</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">IA :</span>
                            <span class="font-medium">${imageData.auto_classification || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Utilisateur :</span>
                            <span class="font-medium">${imageData.user_annotation || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Manuelle :</span>
                            <span class="font-medium">${imageData.manual_annotation || 'N/A'}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Confiance :</span>
                            <span class="font-medium">${imageData.confidence ? (imageData.confidence * 100).toFixed(1) + '%' : 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Caractéristiques techniques -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-3 text-gray-800">🔧 Caractéristiques techniques</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600 block">Dimensions :</span>
                        <span class="font-medium">${imageData.width || 0} × ${imageData.height || 0} px</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Taille :</span>
                        <span class="font-medium">${imageData.file_size ? (imageData.file_size / 1024).toFixed(1) + ' Ko' : 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Luminosité :</span>
                        <span class="font-medium">${imageData.brightness ? imageData.brightness.toFixed(1) : 'N/A'}</span>
                    </div>
                    <div>
                        <span class="text-gray-600 block">Contraste :</span>
                        <span class="font-medium">${imageData.contrast_level ? imageData.contrast_level.toFixed(1) : 'N/A'}</span>
                    </div>
                </div>
            </div>
            
            <!-- Commentaire -->
            ${imageData.comment ? `
            <div class="bg-yellow-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-2 text-gray-800">💬 Commentaire</h4>
                <p class="text-sm text-gray-700">${imageData.comment}</p>
            </div>
            ` : ''}
            
            <!-- Actions -->
            <div class="flex flex-wrap gap-2 justify-center">
                <button onclick="annotateFromTable(${imageData.id}, 'pleine')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                    <i class="fas fa-times mr-2"></i>Marquer pleine
                </button>
                <button onclick="annotateFromTable(${imageData.id}, 'vide')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i class="fas fa-check mr-2"></i>Marquer vide
                </button>
                <button onclick="closeModal(this)" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-times mr-2"></i>Fermer
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Fonction pour annoter depuis le tableau
function annotateFromTable(imageId, annotation) {
    console.log(`📝 Annotation depuis le tableau: ID ${imageId} -> ${annotation}`);
    
    fetch(`/annotate/${imageId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`✅ Image ${imageId} annotée comme "${annotation}"`);
                
                // Rafraîchir les données
                loadRecentReports();
                loadStats();
                loadMapData();
                
                // Fermer la modal si elle est ouverte
                const modal = document.querySelector('.fixed.inset-0');
                if (modal) modal.remove();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('❌ Erreur annotation:', error);
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

// Fonction pour supprimer un signalement (optionnelle)
function deleteReport(imageId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce signalement ?')) {
        console.log(`🗑️ Suppression du signalement ID: ${imageId}`);
        
        fetch(`/api/delete_image/${imageId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage('✅ Signalement supprimé avec succès');
                loadRecentReports();
                loadStats();
                loadMapData();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('❌ Erreur suppression:', error);
            showErrorMessage('Erreur lors de la suppression: ' + error.message);
        });
    }
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Page chargée - Initialisation...');
    
    // Test de connexion serveur
    fetch('/test')
        .then(response => response.json())
        .then(data => {
            console.log('✅ Test serveur réussi:', data);
            showSuccessMessage('✅ Connexion serveur établie');
        })
        .catch(error => {
            console.error('❌ Test serveur échoué:', error);
            showErrorMessage('❌ Problème de connexion au serveur');
        });
    
    initMap();
    initChart();
    loadStats();
    loadRecentReports();
    
    // Attacher les événements de drag and drop
    attachDragAndDropEvents();
    
    // Event listener pour le bouton submit principal
    const submitBtn = document.getElementById('submit-btn');
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('🔘 Bouton submit principal cliqué');
            
            if (window.currentFile) {
                // Si une image est en preview, l'uploader directement
                uploadCurrentImage();
            } else {
                // Sinon, vérifier s'il y a une image dans l'input
                const fileInput = document.getElementById('file-input');
                if (fileInput && fileInput.files && fileInput.files.length > 0) {
                    handleFiles(fileInput.files);
                } else {
                    showErrorMessage('⚠️ Veuillez d\'abord sélectionner une image.');
                }
            }
        });
        console.log('✅ Event listener submit attaché');
    }
    
    // Actualiser les données périodiquement
    setInterval(() => {
        loadStats();
        loadRecentReports();
    }, 30000);
    
    // Scroll smooth pour les boutons du hero
    const scrollReportBtn = document.getElementById('scroll-report-btn');
    const scrollMapBtn = document.getElementById('scroll-map-btn');
    if (scrollReportBtn) {
        scrollReportBtn.addEventListener('click', function() {
            const section = document.getElementById('signalement-section');
            if (section) section.scrollIntoView({ behavior: 'smooth' });
        });
    }
    if (scrollMapBtn) {
        scrollMapBtn.addEventListener('click', function() {
            const section = document.getElementById('map-section');
            if (section) section.scrollIntoView({ behavior: 'smooth' });
        });
    }
});


// Fonction pour charger les données de la carte depuis l'API
function loadMapData() {
    console.log('🗺️ Chargement des données de la carte...');
    
    fetch('/api/poubelles')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(poubelles => {
            console.log('🗺️ Données des poubelles reçues:', poubelles);
            
            // Mettre à jour la carte avec les nouvelles données
            updateMapMarkers(poubelles);
            
            console.log('✅ Carte mise à jour avec succès');
        })
        .catch(error => {
            console.error('❌ Erreur lors du chargement des données de la carte:', error);
            
            // Afficher des données par défaut ou un message d'erreur
            showMapError('Erreur lors du chargement des poubelles');
        });
}

// Variable globale pour stocker les marqueurs
let mapMarkers = [];

// Fonction pour mettre à jour les marqueurs sur la carte
function updateMapMarkers(poubelles) {
    if (!map) {
        console.error('❌ Carte non initialisée');
        return;
    }
    
    // Supprimer tous les marqueurs existants
    mapMarkers.forEach(marker => {
        map.removeLayer(marker);
    });
    mapMarkers = [];
    
    if (!poubelles || poubelles.length === 0) {
        console.log('ℹ️ Aucune poubelle à afficher sur la carte');
        return;
    }
    
    // Ajouter les nouveaux marqueurs
    poubelles.forEach((poubelle, index) => {
        const marker = createMapMarker(poubelle, index);
        if (marker) {
            mapMarkers.push(marker);
            marker.addTo(map);
        }
    });
    
    // Ajuster la vue de la carte pour montrer tous les marqueurs
    if (mapMarkers.length > 0) {
        const group = new L.featureGroup(mapMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    console.log(`✅ ${mapMarkers.length} marqueur(s) ajouté(s) à la carte`);
}

// Fonction pour créer un marqueur sur la carte
function createMapMarker(poubelle, index) {
    // Vérifier si on a des coordonnées valides
    if (!poubelle.lat || !poubelle.lng) {
        console.warn(`⚠️ Coordonnées manquantes pour la poubelle ID ${poubelle.id}`);
        return null;
    }
    
    // Déterminer l'icône selon le statut
    const iconConfig = getMarkerIcon(poubelle.status);
    
    // Créer l'icône personnalisée
    const customIcon = L.divIcon({
        html: `
            <div class="marker-container" style="position: relative;">
                <div class="marker-icon" style="
                    width: 24px; 
                    height: 24px; 
                    background-color: ${iconConfig.color}; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 10px;
                    color: white;
                    font-weight: bold;
                    ${poubelle.status === 'pleine' ? 'animation: pulse 2s infinite;' : ''}
                ">
                    <i class="${iconConfig.icon}"></i>
                </div>
                ${poubelle.status === 'pleine' ? `
                    <div style="
                        position: absolute;
                        top: -25px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: #ef4444;
                        color: white;
                        padding: 2px 6px;
                        border-radius: 3px;
                        font-size: 8px;
                        font-weight: bold;
                        white-space: nowrap;
                    ">URGENT</div>
                ` : ''}
            </div>
        `,
        className: 'custom-marker',
        iconSize: [24, 24],
        iconAnchor: [12, 12]
    });
    
    // Créer le marqueur
    const marker = L.marker([poubelle.lat, poubelle.lng], {
        icon: customIcon
    });
    
    // Créer le contenu du popup
    const popupContent = createPopupContent(poubelle);
    
    // Ajouter le popup au marqueur
    marker.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'custom-popup'
    });
    
    // Ajouter un événement de clic pour plus d'actions
    marker.on('click', function() {
        console.log(`🗺️ Clic sur la poubelle ID: ${poubelle.id}`);
        // Le popup s'ouvre automatiquement, mais on peut ajouter d'autres actions ici
    });
    
    return marker;
}

// Fonction pour obtenir la configuration de l'icône selon le statut
function getMarkerIcon(status) {
    switch(status?.toLowerCase()) {
        case 'pleine':
            return {
                color: '#ef4444',
                icon: 'fas fa-exclamation'
            };
        case 'vide':
            return {
                color: '#22c55e',
                icon: 'fas fa-check'
            };
        case 'non classée':
        case 'inconnu':
            return {
                color: '#6b7280',
                icon: 'fas fa-question'
            };
        default:
            return {
                color: '#f59e0b',
                icon: 'fas fa-clock'
            };
    }
}

// Fonction pour créer le contenu du popup
function createPopupContent(poubelle) {
    const statusColor = poubelle.status === 'pleine' ? 'text-red-600' : 
                       poubelle.status === 'vide' ? 'text-green-600' : 'text-gray-600';
    
    const urgencyBadge = poubelle.status === 'pleine' ? 
        `<span class="inline-block bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full font-semibold mb-2">
            <i class="fas fa-exclamation-triangle mr-1"></i>URGENT
        </span>` : '';
    
    return `
        <div class="popup-content p-3" style="min-width: 250px;">
            <!-- En-tête avec statut -->
            <div class="mb-3">
                ${urgencyBadge}
                <h3 class="font-bold text-lg text-gray-800">
                    <i class="fas fa-trash-alt mr-2"></i>Poubelle #${poubelle.id}
                </h3>
                <p class="text-sm text-gray-600">${poubelle.location || 'Localisation non spécifiée'}</p>
            </div>
            
            <!-- Statut principal -->
            <div class="mb-3 p-2 rounded-lg ${poubelle.status === 'pleine' ? 'bg-red-50' : 'bg-green-50'}">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">État actuel :</span>
                    <span class="font-semibold ${statusColor} capitalize">
                        ${poubelle.status === 'pleine' ? '🗑️' : '✨'} ${poubelle.status}
                    </span>
                </div>
                ${poubelle.confidence ? `
                    <div class="flex items-center justify-between mt-1">
                        <span class="text-xs text-gray-500">Confiance :</span>
                        <span class="text-xs font-medium">${(poubelle.confidence * 100).toFixed(0)}%</span>
                    </div>
                ` : ''}
            </div>
            
            <!-- Informations détaillées -->
            <div class="space-y-2 text-sm">
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">
                        <i class="fas fa-clock mr-1"></i>Dernière mise à jour :
                    </span>
                    <span class="font-medium">${poubelle.time}</span>
                </div>
                
                <div class="flex items-center justify-between">
                    <span class="text-gray-600">
                        <i class="fas fa-map-marker-alt mr-1"></i>Coordonnées :
                    </span>
                    <span class="font-medium text-xs">
                        ${poubelle.lat.toFixed(4)}, ${poubelle.lng.toFixed(4)}
                    </span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="mt-4 flex gap-2">
                <button onclick="viewImageDetails(${poubelle.id})" 
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm px-3 py-2 rounded-lg transition">
                    <i class="fas fa-eye mr-1"></i>Détails
                </button>
                
                ${poubelle.status !== 'pleine' && poubelle.status !== 'vide' ? `
                    <button onclick="annotateFromMap(${poubelle.id}, 'pleine')" 
                            class="flex-1 bg-red-500 hover:bg-red-600 text-white text-sm px-3 py-2 rounded-lg transition">
                        <i class="fas fa-trash-alt mr-1"></i>Pleine
                    </button>
                    <button onclick="annotateFromMap(${poubelle.id}, 'vide')" 
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white text-sm px-3 py-2 rounded-lg transition">
                        <i class="fas fa-check mr-1"></i>Vide
                    </button>
                ` : ''}
            </div>
            
            ${poubelle.status === 'pleine' ? `
                <div class="mt-3 p-2 bg-red-100 border-l-4 border-red-500 rounded">
                    <p class="text-xs text-red-700">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        <strong>Action requise :</strong> Cette poubelle doit être vidée rapidement.
                    </p>
                </div>
            ` : ''}
        </div>
    `;
}

// Fonction pour annoter depuis la carte
function annotateFromMap(poubelleId, annotation) {
    console.log(`📝 Annotation depuis la carte: ID ${poubelleId} -> ${annotation}`);
    
    fetch(`/annotate/${poubelleId}/${annotation}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccessMessage(`✅ Poubelle ${poubelleId} annotée comme "${annotation}"`);
                
                // Rafraîchir toutes les données
                loadMapData();
                loadStats();
                loadRecentReports();
                
                // Fermer tous les popups ouverts
                map.closePopup();
            } else {
                showErrorMessage('Erreur: ' + data.message);
            }
        })
        .catch(error => {
            console.error('❌ Erreur annotation depuis carte:', error);
            showErrorMessage('Erreur lors de l\'annotation: ' + error.message);
        });
}

// Fonction pour afficher une erreur sur la carte
function showMapError(message) {
    // Supprimer tous les marqueurs existants
    mapMarkers.forEach(marker => {
        map.removeLayer(marker);
    });
    mapMarkers = [];
    
    // Ajouter un marqueur d'erreur au centre de la carte
    const errorIcon = L.divIcon({
        html: `
            <div style="
                background: #ef4444;
                color: white;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                white-space: nowrap;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            ">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                ${message}
            </div>
        `,
        className: 'error-marker',
        iconSize: [200, 30],
        iconAnchor: [100, 15]
    });
    
    const errorMarker = L.marker(map.getCenter(), {
        icon: errorIcon
    });
    
    errorMarker.addTo(map);
    mapMarkers.push(errorMarker);
    
    // Supprimer le marqueur d'erreur après 5 secondes
    setTimeout(() => {
        map.removeLayer(errorMarker);
        mapMarkers = mapMarkers.filter(m => m !== errorMarker);
    }, 5000);
}

// Fonction pour centrer la carte sur une poubelle spécifique
function centerMapOnBin(poubelleId) {
    const marker = mapMarkers.find(m => {
        const popup = m.getPopup();
        return popup && popup.getContent().includes(`#${poubelleId}`);
    });
    
    if (marker) {
        map.setView(marker.getLatLng(), 16);
        marker.openPopup();
        console.log(`🎯 Carte centrée sur la poubelle ${poubelleId}`);
    } else {
        console.warn(`⚠️ Poubelle ${poubelleId} non trouvée sur la carte`);
    }
}

// Fonction pour filtrer les marqueurs par statut
function filterMapMarkers(status) {
    mapMarkers.forEach(marker => {
        const popup = marker.getPopup();
        const content = popup ? popup.getContent() : '';
        
        if (status === 'all') {
            // Afficher tous les marqueurs
            marker.setOpacity(1);
        } else {
            // Afficher seulement les marqueurs correspondant au statut
            const shouldShow = content.toLowerCase().includes(status.toLowerCase());
            marker.setOpacity(shouldShow ? 1 : 0.3);
        }
    });
    
    console.log(`🔍 Filtrage des marqueurs par statut: ${status}`);
}

// Ajouter les styles CSS pour les marqueurs animés
const mapStyles = document.createElement('style');
mapStyles.textContent = `
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .custom-popup .leaflet-popup-content-wrapper {
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .custom-popup .leaflet-popup-content {
        margin: 0;
        line-height: 1.4;
    }
    
    .custom-marker {
        background: transparent;
        border: none;
    }
`;
document.head.appendChild(mapStyles);

// Reste des fonctions inchangées (initMap, loadMapData, etc.)
// [Gardez toutes les autres fonctions comme elles sont]

// Charger la carte avec des données réelles
function initMap() {
    map = L.map('map').setView([-32.74044740396817, -56.00385146995099], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    loadMapData();
}

// [Continuez avec toutes les autres fonctions existantes...]
// (loadMapData, viewImageDetails, handleAction, loadRecentReports, loadStats, updateChart, initChart)

</script>